<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>pbrt-v4 Ep. IV: 辐射与光 &#183; tsssni's blowfish blog</title>
<meta name=title content="pbrt-v4 Ep. IV: 辐射与光 &#183; tsssni's blowfish blog"><meta name=description content="pbrt v4 episode 4"><meta name=keywords content="graphics,rendering,pbrt,"><link rel=canonical href=https://tsssni.github.io/render/1728265562044-pbrt-v4-episode-4/><link type=text/css rel=stylesheet href=/css/main.bundle.min.ca647953499921416b0d05469d49a4d04fcbf2b7d4f24a78e081a88e623fcd759e6a85cf497adecba41a7abd7e3688d40038faf3208fce082f5446f2c8c17871.css integrity="sha512-ymR5U0mZIUFrDQVGnUmk0E/L8rfU8kp44IGojmI/zXWeaoXPSXrey6Qaer1+NojUADj68yCPzggvVEbyyMF4cQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.c178288131a2f1ad46910438db47ac5f7e1c48cf949e49f6dc3310c8ec9660e23fe505805eba4e2e73711335808500360d773a2b64322feb35df52856edca286.js integrity="sha512-wXgogTGi8a1GkQQ420esX34cSM+Unkn23DMQyOyWYOI/5QWAXrpOLnNxEzWAhQA2DXc6K2QyL+s131KFbtyihg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://tsssni.github.io/render/1728265562044-pbrt-v4-episode-4/"><meta property="og:site_name" content="tsssni's blowfish blog"><meta property="og:title" content="pbrt-v4 Ep. IV: 辐射与光"><meta property="og:description" content="pbrt v4 episode 4"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="render"><meta property="article:published_time" content="2024-10-07T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-07T00:00:00+00:00"><meta property="article:tag" content="Graphics"><meta property="article:tag" content="Rendering"><meta property="article:tag" content="Pbrt"><meta property="og:image" content="https://tsssni.github.io/render/1728265562044-pbrt-v4-episode-4/featured.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tsssni.github.io/render/1728265562044-pbrt-v4-episode-4/featured.jpg"><meta name=twitter:title content="pbrt-v4 Ep. IV: 辐射与光"><meta name=twitter:description content="pbrt v4 episode 4"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Rendering","name":"pbrt-v4 Ep. IV: 辐射与光","headline":"pbrt-v4 Ep. IV: 辐射与光","description":"pbrt v4 episode 4","inLanguage":"zh-cn","url":"https:\/\/tsssni.github.io\/render\/1728265562044-pbrt-v4-episode-4\/","author":{"@type":"Person","name":""},"copyrightYear":"2024","dateCreated":"2024-10-07T00:00:00\u002b00:00","datePublished":"2024-10-07T00:00:00\u002b00:00","dateModified":"2024-10-07T00:00:00\u002b00:00","keywords":["graphics","rendering","pbrt"],"mainEntityOfPage":"true","wordCount":"7268"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link type=text/css rel=stylesheet href=/lib/katex/katex.min.68e17230ccd917b97b7a2def38a8108918599d8aa4f580bfb8cce5e13d23e4de43dcaba5f9000553cb2c10d0d1300aabfe5c433a3305ebd752609f0762a63e59.css integrity="sha512-aOFyMMzZF7l7ei3vOKgQiRhZnYqk9YC/uMzl4T0j5N5D3Kul+QAFU8ssENDRMAqr/lxDOjMF69dSYJ8HYqY+WQ=="><script defer src=/lib/katex/katex.min.50f14e69d6a8da7128ae3b63974c544ed377c36d096b5e3750f114e84c89d668b9301d9b0ed3248969aa183aa2e3bc4d2c1e73d5dcb7d462890c45a18d424589.js integrity="sha512-UPFOadao2nEorjtjl0xUTtN3w20Ja143UPEU6EyJ1mi5MB2bDtMkiWmqGDqi47xNLB5z1dy31GKJDEWhjUJFiQ=="></script><script defer src=/lib/katex/auto-render.min.6095714e3aadb63b14ddc4af69346ab12974c1b460654345f8d1860a0b68fcc51b22f68b757433193090bb80afc8965b65cb607e5541d0f5f0f4b2e64d69b9ff.js integrity="sha512-YJVxTjqttjsU3cSvaTRqsSl0wbRgZUNF+NGGCgto/MUbIvaLdXQzGTCQu4CvyJZbZctgflVB0PXw9LLmTWm5/w==" onload=renderMathInElement(document.body)></script><script data-id=umami-script async src=https://analytics.umami.is/script.js data-website-id=e54a34b7-b153-41c0-a794-bb050c0c1abc></script><script type=text/javascript>document.querySelector('script[data-id="umami-script"]').addEventListener("load",function(){const e=document.head.querySelector('meta[property = "og:type"]').getAttribute("content");let t=document.head.querySelector('meta[property = "og:title"]').getAttribute("content"),n=document.head.querySelector('meta[property = "og:url"]').getAttribute("content");umami.track(e+":"+t,{url:n})})</script><meta name=theme-color><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyAB04I5m3aWYDSR1j8C79UeKrBzVRF90Qg",authDomain:"AIzaSyAB04I5m3aWYDSR1j8C79UeKrBzVRF90Qg",projectId:"tsssni-s-blowfish-blog",storageBucket:"tsssni-s-blowfish-blog.appspot.com",messagingSenderId:"1044986167854",appId:"1:1044986167854:web:d5234c7787ec0a86e215bf",measurementId:"G-S2WG8P11SW"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">tsssni&rsquo;s blowfish blog</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/render/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>渲染</p></a><a href=/unix/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Unix</p></a><a href=/acgn/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>ACGN</p></a><a href=/about/1717500731146-about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>关于</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/render/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>渲染</p></a></li><li class=mt-1><a href=/unix/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Unix</p></a></li><li class=mt-1><a href=/acgn/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>ACGN</p></a></li><li class=mt-1><a href=/about/1717500731146-about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>关于</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="w-full rounded-md h-36 md:h-56 lg:h-72 single_hero_basic nozoom" style=background-image:url(/render/1728265562044-pbrt-v4-episode-4/featured_hu5690427664021626422.jpg)></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/plana-hero_hu8552895425971263243.png)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-30 dark:opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">pbrt-v4 Ep. IV: 辐射与光</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-10-07T00:00:00+00:00>2024 October 7</time><span class="px-2 text-primary-500">&#183;</span><span>7268 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>15 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_render/1728265562044-pbrt-v4-episode-4/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_render/1728265562044-pbrt-v4-episode-4/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400" onclick=process_article()>
<span id=button_likes_heart style=display:none class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg>
</span></span><span id=button_likes_text>&nbsp;Like</span></button></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/graphics/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Graphics
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/rendering/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Rendering
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/pbrt/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Pbrt</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#辐射度量学>辐射度量学</a><ul><li><a href=#基本量>基本量</a><ul><li><a href=#能量>能量</a></li><li><a href=#辐射通量>辐射通量</a></li><li><a href=#辐射照度--辐射出射度>辐射照度 & 辐射出射度</a></li><li><a href=#辐射强度>辐射强度</a></li><li><a href=#辐射亮度>辐射亮度</a></li></ul></li><li><a href=#入射出射辐射方程>入射/出射辐射方程</a></li><li><a href=#辐射光谱分布>辐射光谱分布</a></li><li><a href=#亮度与光度>亮度与光度</a></li></ul></li><li><a href=#辐射度量值的积分>辐射度量值的积分</a><ul><li><a href=#投影立体角上的积分>投影立体角上的积分</a></li><li><a href=#球面坐标系上的积分>球面坐标系上的积分</a></li><li><a href=#面积上的积分>面积上的积分</a></li></ul></li><li><a href=#表面反射>表面反射</a><ul><li><a href=#brdf>BRDF</a></li><li><a href=#btdf>BTDF</a></li><li><a href=#bsdf>BSDF</a></li><li><a href=#bssrdf>BSSRDF</a></li></ul></li><li><a href=#自发光>自发光</a><ul><li><a href=#黑体发光>黑体发光</a></li><li><a href=#标准光源>标准光源</a></li></ul></li><li><a href=#光谱分布>光谱分布</a><ul><li><a href=#光谱接口>光谱接口</a></li><li><a href=#通用光谱分布>通用光谱分布</a><ul><li><a href=#constantspectrum>ConstantSpectrum</a></li><li><a href=#denselysampledspectrum>DenselySampledSpectrum</a></li><li><a href=#piecewiselinearspectrum>PiecewiseLinearSpectrum</a></li><li><a href=#blackbodyspectrum>BlackbodySpectrum</a></li></ul></li><li><a href=#嵌入光谱数据>嵌入光谱数据</a></li><li><a href=#采样光谱分布>采样光谱分布</a><ul><li><a href=#sampledspectrum>SampledSpectrum</a></li><li><a href=#sampledwavelengths>SampledWavelengths</a></li></ul></li></ul></li><li><a href=#颜色>颜色</a><ul><li><a href=#xyz色彩空间>XYZ色彩空间</a></li><li><a href=#xyy色彩空间>xyY色彩空间</a></li><li><a href=#rgb颜色>RGB颜色</a></li><li><a href=#rgb色彩空间>RGB色彩空间</a><ul><li><a href=#标准色彩空间>标准色彩空间</a></li></ul></li><li><a href=#使用光谱渲染的原因>使用光谱渲染的原因</a></li><li><a href=#波长样本数的选择>波长样本数的选择</a></li><li><a href=#rgb转光谱>RGB转光谱</a><ul><li><a href=#无界光谱>无界光谱</a></li><li><a href=#自发光光谱>自发光光谱</a></li></ul></li></ul></li><li><a href=#结语>结语</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#辐射度量学>辐射度量学</a><ul><li><a href=#基本量>基本量</a><ul><li><a href=#能量>能量</a></li><li><a href=#辐射通量>辐射通量</a></li><li><a href=#辐射照度--辐射出射度>辐射照度 & 辐射出射度</a></li><li><a href=#辐射强度>辐射强度</a></li><li><a href=#辐射亮度>辐射亮度</a></li></ul></li><li><a href=#入射出射辐射方程>入射/出射辐射方程</a></li><li><a href=#辐射光谱分布>辐射光谱分布</a></li><li><a href=#亮度与光度>亮度与光度</a></li></ul></li><li><a href=#辐射度量值的积分>辐射度量值的积分</a><ul><li><a href=#投影立体角上的积分>投影立体角上的积分</a></li><li><a href=#球面坐标系上的积分>球面坐标系上的积分</a></li><li><a href=#面积上的积分>面积上的积分</a></li></ul></li><li><a href=#表面反射>表面反射</a><ul><li><a href=#brdf>BRDF</a></li><li><a href=#btdf>BTDF</a></li><li><a href=#bsdf>BSDF</a></li><li><a href=#bssrdf>BSSRDF</a></li></ul></li><li><a href=#自发光>自发光</a><ul><li><a href=#黑体发光>黑体发光</a></li><li><a href=#标准光源>标准光源</a></li></ul></li><li><a href=#光谱分布>光谱分布</a><ul><li><a href=#光谱接口>光谱接口</a></li><li><a href=#通用光谱分布>通用光谱分布</a><ul><li><a href=#constantspectrum>ConstantSpectrum</a></li><li><a href=#denselysampledspectrum>DenselySampledSpectrum</a></li><li><a href=#piecewiselinearspectrum>PiecewiseLinearSpectrum</a></li><li><a href=#blackbodyspectrum>BlackbodySpectrum</a></li></ul></li><li><a href=#嵌入光谱数据>嵌入光谱数据</a></li><li><a href=#采样光谱分布>采样光谱分布</a><ul><li><a href=#sampledspectrum>SampledSpectrum</a></li><li><a href=#sampledwavelengths>SampledWavelengths</a></li></ul></li></ul></li><li><a href=#颜色>颜色</a><ul><li><a href=#xyz色彩空间>XYZ色彩空间</a></li><li><a href=#xyy色彩空间>xyY色彩空间</a></li><li><a href=#rgb颜色>RGB颜色</a></li><li><a href=#rgb色彩空间>RGB色彩空间</a><ul><li><a href=#标准色彩空间>标准色彩空间</a></li></ul></li><li><a href=#使用光谱渲染的原因>使用光谱渲染的原因</a></li><li><a href=#波长样本数的选择>波长样本数的选择</a></li><li><a href=#rgb转光谱>RGB转光谱</a><ul><li><a href=#无界光谱>无界光谱</a></li><li><a href=#自发光光谱>自发光光谱</a></li></ul></li></ul></li><li><a href=#结语>结语</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>辐射度量学研究光的表示与传播, pbrt通过光谱而非RGB来表示颜色.</p><h2 class="relative group">辐射度量学<div id=%E8%BE%90%E5%B0%84%E5%BA%A6%E9%87%8F%E5%AD%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E5%BA%A6%E9%87%8F%E5%AD%A6 aria-label=锚点>#</a></span></h2><p>几何光学足够用于完成渲染任务, 主要损失在于无法模拟干涉与衍射.
几何光学具有以下特征.</p><ol><li>线性</li><li>能量守恒</li><li>无偏振</li><li>无荧光、磷光, 即光在某个波长下的表现与别的波长或时间下的表现无关</li><li>状态稳定, 即辐射亮度分布不随时间变化</li></ol><h3 class="relative group">基本量<div id=%E5%9F%BA%E6%9C%AC%E9%87%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9F%BA%E6%9C%AC%E9%87%8F aria-label=锚点>#</a></span></h3><h4 class="relative group">能量<div id=%E8%83%BD%E9%87%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%83%BD%E9%87%8F aria-label=锚点>#</a></span></h4><p>光源发出光子, 光子携带能量.
能量单位为焦耳(J), 特定波长的光子携带的能量如下式.
其中c为光速, h为Planck常量, \(h = 6.626\times 10^{-34} m^2 kg/s\).</p><p>$$
\begin{equation}
Q = \frac{hc}{\lambda}
\end{equation}
$$</p><h4 class="relative group">辐射通量<div id=%E8%BE%90%E5%B0%84%E9%80%9A%E9%87%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E9%80%9A%E9%87%8F aria-label=锚点>#</a></span></h4><p>辐射通量是(radiant flux)单位时间通过表面或空间的能量,
也可以被称作功率(power), 单位为J/s, 即瓦特(W).
辐射通量的定义见下式.</p><p>$$
\begin{equation}
\Phi = \frac{dQ}{dt}
\end{equation}
$$</p><p>对于一个点光源, 辐射通量为以光源为球心的球面单位时间接收到的能量,
球的半径不影响辐射通量的值.</p><h4 class="relative group">辐射照度 & 辐射出射度<div id=%E8%BE%90%E5%B0%84%E7%85%A7%E5%BA%A6--%E8%BE%90%E5%B0%84%E5%87%BA%E5%B0%84%E5%BA%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E7%85%A7%E5%BA%A6--%E8%BE%90%E5%B0%84%E5%87%BA%E5%B0%84%E5%BA%A6 aria-label=锚点>#</a></span></h4><p>辐射照度(irradiance)是单位面积接收到的辐射通量,
与之对应的辐射出射度(radiant exitance)是单位面积发出的辐射通量,
他们的单位为\(W/m^2\).</p><p>$$
\begin{equation}
E(p) = \frac{d\Phi}{dA}
\end{equation}
$$</p><p>同样以点光源为例, 以光源为球心的球面的辐射照度见下式.</p><p>$$
\begin{equation}
E = \frac{\Phi}{4 \pi r^2}
\end{equation}
$$</p><p>非垂直光线根据投影到光线垂直面的面积计算, \(\theta\)为光线与法线的夹角.</p><p>$$
\begin{equation}
E(p) = \frac{d\Phi \cos\theta}{dA}
\end{equation}
$$</p><h4 class="relative group">辐射强度<div id=%E8%BE%90%E5%B0%84%E5%BC%BA%E5%BA%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E5%BC%BA%E5%BA%A6 aria-label=锚点>#</a></span></h4><p>辐射强度(radiant intensity)是单位立体角上的辐射通量,
它描述了光在方向上的分布, 但实际上只对点光源有意义.</p><p>$$
\begin{equation}
I = \frac{dQ}{d\omega}
\end{equation}
$$</p><p>以点光源为球心的球面的辐射强度见下式.</p><p>$$
\begin{equation}
I = \frac{\Phi}{4 \pi}
\end{equation}
$$</p><h4 class="relative group">辐射亮度<div id=%E8%BE%90%E5%B0%84%E4%BA%AE%E5%BA%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E4%BA%AE%E5%BA%A6 aria-label=锚点>#</a></span></h4><p>辐射亮度(radiance)是单位面积单位立体角上的辐射通量, 即将辐射照度进一步在每个方向上微分.
辐射亮度定义见下式, 其中\(E_{\omega}\)代表与\(\omega\)垂直的表面的辐射照度.</p><p>$$
\begin{equation}
L(p, \omega)
= \frac{E_{\omega}(p)}{d\omega}
= \frac{d^2\Phi}{d\omega dA^{\perp}}
= \frac{d^2\Phi}{d\omega dA \cos\theta}
\end{equation}
$$</p><p>辐射亮度是渲染任务中最重要的辐射度量值, 别的值都可以由它积分得到,
且光在真空中传播时具有辐射亮度不变的特性.</p><h3 class="relative group">入射/出射辐射方程<div id=%E5%85%A5%E5%B0%84%E5%87%BA%E5%B0%84%E8%BE%90%E5%B0%84%E6%96%B9%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%85%A5%E5%B0%84%E5%87%BA%E5%B0%84%E8%BE%90%E5%B0%84%E6%96%B9%E7%A8%8B aria-label=锚点>#</a></span></h3><p>辐射亮度在表面边界处未必是连续的, 表面某点上方与下方的极限值需要单独表示.</p><p>$$
\begin{equation}
L^+(p,\omega)=\lim_{t \to 0^+} L(p + t \bold{n}_p, \omega)
\end{equation}
$$</p><p>$$
\begin{equation}
L^-(p,\omega)=\lim_{t \to 0^-} L(p - t \bold{n}_p, \omega)
\end{equation}
$$</p><p>为解决这一问题需要区分入射与出射辐射亮度.</p><p>$$
\begin{equation}
L_i(p, \omega) =
\begin{cases}
L^+(p, -\omega), & \omega \cdot \bold{n}_p > 0\\
L^-(p, -\omega), & \omega \cdot \bold{n}_p &lt; 0
\end{cases}
\end{equation}
$$</p><p>$$
\begin{equation}
L_i(p, \omega) =
\begin{cases}
L^+(p, \omega), & \omega \cdot \bold{n}_p > 0\\
L^-(p, \omega), & \omega \cdot \bold{n}_p &lt; 0
\end{cases}
\end{equation}
$$</p><p>对于空间中不在表面上的某点, 辐射亮度是连续的.</p><p>$$
\begin{equation}
L_o(p, \omega) = L_i(p, -\omega) = L(p, \omega)
\end{equation}
$$</p><h3 class="relative group">辐射光谱分布<div id=%E8%BE%90%E5%B0%84%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 aria-label=锚点>#</a></span></h3><p>辐射亮度可以进一步对波长微分以获取辐射光谱分布.</p><p>$$
\begin{equation}
L_\lambda = \frac{dL}{d\lambda}
\end{equation}
$$</p><h3 class="relative group">亮度与光度<div id=%E4%BA%AE%E5%BA%A6%E4%B8%8E%E5%85%89%E5%BA%A6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BA%AE%E5%BA%A6%E4%B8%8E%E5%85%89%E5%BA%A6 aria-label=锚点>#</a></span></h3><p>辐射度单位都有与之对应的光度单位, 这里只讨论最基本的亮度, 其余可以积分得到.
亮度表示人眼观察到的某个光谱功率分布的值, 定义如下.
V为响应曲线即人眼对各个波长的光的敏感程度, 目前所使用的响应曲线是基于室内的实验得到的,
人眼在较暗环境对颜色的敏感度会降低, 因此无法很好的表示室外光照环境, 但仍然将其作为研究基准.</p><p>$$
\begin{equation}
Y = \int_{\lambda} L_\lambda(\lambda) V(\lambda) d\lambda
\end{equation}
$$</p><h2 class="relative group">辐射度量值的积分<div id=%E8%BE%90%E5%B0%84%E5%BA%A6%E9%87%8F%E5%80%BC%E7%9A%84%E7%A7%AF%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BE%90%E5%B0%84%E5%BA%A6%E9%87%8F%E5%80%BC%E7%9A%84%E7%A7%AF%E5%88%86 aria-label=锚点>#</a></span></h2><p>从辐射亮度到辐射照度的积分如图所示, 其中\(\Omega\)是法线上方半球覆盖的立体角,
\(\theta\)是立体角在单位球上对应的向量与法线的夹角.</p><p>$$
\begin{equation}
E(p, \bold{n}) = \int_\Omega L_i(p,\omega) |\cos\theta| d\omega
\end{equation}
$$</p><h3 class="relative group">投影立体角上的积分<div id=%E6%8A%95%E5%BD%B1%E7%AB%8B%E4%BD%93%E8%A7%92%E4%B8%8A%E7%9A%84%E7%A7%AF%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%8A%95%E5%BD%B1%E7%AB%8B%E4%BD%93%E8%A7%92%E4%B8%8A%E7%9A%84%E7%A7%AF%E5%88%86 aria-label=锚点>#</a></span></h3><p>通过将单位球上的立体角投影到与法线垂直的平面可以转化为2D上的积分,
投影立体角与立体角满足Lambert定律. pbrt不会使用这种积分.</p><p>$$
\begin{equation}
\begin{aligned}
d\omega^{\perp} &= d\omega|cos\theta|\\
E(p, \bold{n}) &= \int_{H^2(\bold{n})} L_i(p,\omega) d\omega^{\perp}
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">球面坐标系上的积分<div id=%E7%90%83%E9%9D%A2%E5%9D%90%E6%A0%87%E7%B3%BB%E4%B8%8A%E7%9A%84%E7%A7%AF%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%90%83%E9%9D%A2%E5%9D%90%E6%A0%87%E7%B3%BB%E4%B8%8A%E7%9A%84%E7%A7%AF%E5%88%86 aria-label=锚点>#</a></span></h3><p>利用单位球表面积可以将立体角微分转化为球面坐标系.</p><p>$$
\begin{equation}
\begin{aligned}
d\omega &= sin\theta d\theta d\phi\\
E(p, \bold{n}) &= \int_0^{2\pi} \int_0^{\frac{\pi}{2}} L_i(p, \theta, \phi) cos\theta sin\theta d\theta d\phi
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">面积上的积分<div id=%E9%9D%A2%E7%A7%AF%E4%B8%8A%E7%9A%84%E7%A7%AF%E5%88%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%9D%A2%E7%A7%AF%E4%B8%8A%E7%9A%84%E7%A7%AF%E5%88%86 aria-label=锚点>#</a></span></h3><p>这里的面积指的是立体角对应的入射光源处的面积, 这种转化可以方便度量面积光源对某一点的影响.
\(\theta_o\)是这个面积位于的平面与立体角对应的向量的夹角, r是这个表面与辐射照度度量点的距离.</p><p>$$
\begin{equation}
\begin{aligned}
d\omega &= \frac{\cos\theta_o dA}{r^2}\\
E(p, \bold{n}) &= \int_{A} L cos\theta_i \frac{\cos\theta_o dA}{r^2}
\end{aligned}
\end{equation}
$$</p><h2 class="relative group">表面反射<div id=%E8%A1%A8%E9%9D%A2%E5%8F%8D%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%A1%A8%E9%9D%A2%E5%8F%8D%E5%B0%84 aria-label=锚点>#</a></span></h2><p>我们需要反射光线的光谱与方向分布来描述反射, 对于透明物体更复杂的次表面光线传播会影响出射光线的位置.
渲染任务中通过BRDF与BSSRDF来抽象这一过程, BRDF描述反射, BSSRDF在此基础上考虑透明物体.</p><h3 class="relative group">BRDF<div id=brdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#brdf aria-label=锚点>#</a></span></h3><p>BRDF代表双向反射分布函数, 它描述出射辐射亮度与入射辐射照度的关系.</p><p>$$
\begin{equation}
f_r(p, \omega_o, \omega_i) = \frac{dL_o(p, \omega_o)}{dE(p, \omega_i)} = \frac{dL_o(p, \omega_o)}{L_i(p, \omega_i) \cos\theta_i d\omega_i}
\end{equation}
$$</p><p>BRDF具有以下两点性质.</p><ol><li>互易性</li></ol><p>$$
\begin{equation}
f_r(p, \omega_o, \omega_i) = f_r(p, \omega_i, \omega_o)
\end{equation}
$$</p><ol start=2><li>能量守恒</li></ol><p>$$
\begin{equation}
\int_\Omega f_r(p, \omega_o, \omega_i) cos\theta_i d\omega_i &lt; 1
\end{equation}
$$</p><p>BRDF的半球-方向反射量可以用于表示入射光从所有方向均匀照射时某个方向的反射辐射亮度,
由于互易性也可以表示各个方向都具有相同的反射辐射亮度时对应的某个方向的入射辐射亮度.</p><p>$$
\begin{equation}
\rho_{hd}(\omega_o) = \int_\Omega f_r(p, \omega_o, \omega_i) cos\theta_i d\omega_i
\end{equation}
$$</p><p>BRDF的半球-半球反射量代表入射光从所有方向均匀照射时的反射率.</p><p>$$
\begin{equation}
\rho_{hh} = \int_\Omega \frac{\int_\Omega f_r(p, \omega_o, \omega_i) \cos\theta_i d\omega_i}{\int_\Omega \cos\theta_i d\omega_i} \cos\theta_o d\omega_o
\end{equation}
$$</p><h3 class="relative group">BTDF<div id=btdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#btdf aria-label=锚点>#</a></span></h3><p>BTDF代表双向透射分布函数, 与BRDF具有相似的形式, 它不遵循互易性.</p><h3 class="relative group">BSDF<div id=bsdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bsdf aria-label=锚点>#</a></span></h3><p>将BRDF与BTDF一起考虑时被称为BSDF, 即双向散射分布函数, 此时可以使用整个球面的入射光线计算出射方向的辐射亮度.</p><p>$$
\begin{equation}
L_o(p, \omega_o) = \int_\Theta f(p, \omega_o, \omega_i) L_i(p, \omega_i) |\cos\theta_i| d\omega_i
\end{equation}
$$</p><h3 class="relative group">BSSRDF<div id=bssrdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bssrdf aria-label=锚点>#</a></span></h3><p>BSSRDF代表双向散射表面反射分布函数, 时出射位置辐射亮度微分与入射位置辐射通量微分的比值,
用于表示光线在表面内部传播再后离开表面的现象, 即次表面散射.</p><p>$$
\begin{equation}
S(p_o, \omega_o, p_i, \omega_i) = \frac{dL_o(p_o, \omega_o)}{d\Phi(p_i, \omega_i)}
\end{equation}
$$</p><p>出射辐射亮度需要计算在入射立体角与面积上的积分.</p><p>$$
\begin{equation}
L_o(p_o, \omega_o) = \int_A \int_\Omega S(p_o, \omega_o, p_i, \omega_i) L_i(p_i, \omega_i) |\cos\theta_i| d\omega_i dA
\end{equation}
$$</p><h2 class="relative group">自发光<div id=%E8%87%AA%E5%8F%91%E5%85%89 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%87%AA%E5%8F%91%E5%85%89 aria-label=锚点>#</a></span></h2><p>达到一定温度后带电荷的原子的运动会导致不同波长的电磁辐射的释放, 室温下大部分物体只发射红外光.</p><p>发光效率代表光源将多少功率转化为可见光, 单位lm/W.
分母可以是光源使用的功率或发出的所有波长上的功率, 若为使用功率,
则发光效率也代表光源将功率转化为电磁辐射的效率.</p><p>此外, 光出射度与辐射照度在单位面积上的比值或出射亮度与辐射亮度在单位面积单位立体角上的比值也可以定义发光效率.</p><p>$$
\begin{equation}
\frac{\int_\lambda \Phi_e(\lambda) V(\lambda) d\lambda}{\int_\lambda \Phi_i(\lambda) d\lambda}
\end{equation}
$$</p><h3 class="relative group">黑体发光<div id=%E9%BB%91%E4%BD%93%E5%8F%91%E5%85%89 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%BB%91%E4%BD%93%E5%8F%91%E5%85%89 aria-label=锚点>#</a></span></h3><p>黑体是一种理想发光光源, 可以最高效率的将功率转化为电磁辐射.
黑体这个名字是因为它几乎吸收所有波长的光线且不会反射它们.</p><p>Planck定律表达了黑体中波长、温度与辐射亮度的关系.
h为Planck常数, c为光速, \(k_b\)为Boltzmann常数, \(k_b = 1.3806488 \times 10^{-23} J/K\).</p><p>$$
\begin{equation}
L_e(\lambda, T) = \frac{2hc^2}{\lambda^5(e^{\frac{hc}{\lambda k_b T}} - 1)}
\end{equation}
$$</p><p>根据Kirchhoff定律, 非黑体的辐射与它吸收掉的辐射亮度相关, 利用半球-方向反射量可以得到下式.</p><p>$$
\begin{equation}
{L_e}&rsquo;(T, \omega, \lambda) = L_e(\lambda, T)(1 - \rho_{hd}(\omega))
\end{equation}
$$</p><p>Stefan–Boltzmann定律给出了黑体的辐射出射度, \(\sigma\)为Stefan–Boltzmann常数,
\(\sigma = 5.67032 \times 10^{-8} Wm^{-2}K^{-4}\).</p><p>$$
\begin{equation}
M(p) = \sigma T^4
\end{equation}
$$</p><p>若发光体发出的光谱分布与某个温度下黑体辐射发出的光谱分布类似, 此时该发光体以该温度作为色温.
通过光源发光最大处的波长与Wien位移定律可以确定当前的色温, b为Wien位移常数,
\(b = 2.897721 \times 10^{-3}mK\).</p><p>$$
\begin{equation}
\lambda_{\max} = \frac{b}{T}
\end{equation}
$$</p><p>通常5000K以上的色温为冷色, 2700-3000K为暖色.</p><h3 class="relative group">标准光源<div id=%E6%A0%87%E5%87%86%E5%85%89%E6%BA%90 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%A0%87%E5%87%86%E5%85%89%E6%BA%90 aria-label=锚点>#</a></span></h3><p>标准光源是由CIE(国际照明委员会)定义的.</p><p>标准光源A用于表示常见的白炽灯, 色温2856K.</p><p>标准光源D用于描述日光的不同阶段, 一个权重用于表示受云量影响的黄蓝变化,
另一个表示受湿度影响的粉绿变化. D65与欧洲中午光照类似, 色温6504K, CIE推荐将它作为标准日光.</p><p>标准光源F用于表示荧光.</p><h2 class="relative group">光谱分布<div id=%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 aria-label=锚点>#</a></span></h2><p>本节主要介绍pbrt中对光谱的抽象, 注意这里并不特指辐射光谱分布, 可以是任意值的分布. pbrt只会存储可见光.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>constexpr</span> <span class=n>Float</span> <span class=n>Lambda_min</span> <span class=o>=</span> <span class=mi>360</span><span class=p>,</span> <span class=n>Lambda_max</span> <span class=o>=</span> <span class=mi>830</span><span class=p>;</span>
</span></span></code></pre></div><h3 class="relative group">光谱接口<div id=%E5%85%89%E8%B0%B1%E6%8E%A5%E5%8F%A3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%85%89%E8%B0%B1%E6%8E%A5%E5%8F%A3 aria-label=锚点>#</a></span></h3><p>pbrt中的<code>Spectrum</code>继承自<code>TaggedPointer</code>来实现运行时多态并避免虚表开销,
<code>TaggedPointer</code>中定义的函数子类必须实现.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>class</span> <span class=nc>Spectrum</span> <span class=o>:</span> <span class=k>public</span> <span class=n>TaggedPointer</span><span class=o>&lt;</span><span class=n>ConstantSpectrum</span><span class=p>,</span> <span class=n>DenselySampledSpectrum</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>PiecewiseLinearSpectrum</span><span class=p>,</span> <span class=n>RGBAlbedoSpectrum</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>RGBUnboundedSpectrum</span><span class=p>,</span> <span class=n>RGBIlluminantSpectrum</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>BlackbodySpectrum</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></div><p><code>Spectrum</code>通过函数子返回特定波长下的分布. <code>Dispatch</code>用于确定分派函数到具体实现.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kr>inline</span> <span class=n>Float</span> <span class=n>Spectrum</span><span class=o>::</span><span class=k>operator</span><span class=p>()(</span><span class=n>Float</span> <span class=n>lambda</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>op</span> <span class=o>=</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>](</span><span class=k>auto</span> <span class=n>ptr</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=p>(</span><span class=o>*</span><span class=n>ptr</span><span class=p>)(</span><span class=n>lambda</span><span class=p>);</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>Dispatch</span><span class=p>(</span><span class=n>op</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>Spectrum</code>的实现必须提供<code>MaxValue</code>以保证高效的采样.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Float</span> <span class=nf>MaxValue</span><span class=p>()</span> <span class=k>const</span><span class=p>;</span>
</span></span></code></pre></div><h3 class="relative group">通用光谱分布<div id=%E9%80%9A%E7%94%A8%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%80%9A%E7%94%A8%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 aria-label=锚点>#</a></span></h3><h4 class="relative group">ConstantSpectrum<div id=constantspectrum class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#constantspectrum aria-label=锚点>#</a></span></h4><p>返回常数值.</p><h4 class="relative group">DenselySampledSpectrum<div id=denselysampledspectrum class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#denselysampledspectrum aria-label=锚点>#</a></span></h4><p><code>DenselySampledSpectrum</code>存储\([\lambda_min, \lambda_max]\)下以1nm为区间采样到的值.
这通过采样另一个<code>Spectrum</code>来实现. 显然这种查表方法会分配较大的内存.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>DenselySampledSpectrum</span><span class=p>(</span><span class=n>Spectrum</span> <span class=n>spec</span><span class=p>,</span> <span class=kt>int</span> <span class=n>lambda_min</span> <span class=o>=</span> <span class=n>Lambda_min</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=kt>int</span> <span class=n>lambda_max</span> <span class=o>=</span> <span class=n>Lambda_max</span><span class=p>,</span> <span class=n>Allocator</span> <span class=n>alloc</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=n>lambda_min</span><span class=p>(</span><span class=n>lambda_min</span><span class=p>),</span> <span class=n>lambda_max</span><span class=p>(</span><span class=n>lambda_max</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=n>values</span><span class=p>(</span><span class=n>lambda_max</span> <span class=o>-</span> <span class=n>lambda_min</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>alloc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>spec</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>lambda</span> <span class=o>=</span> <span class=n>lambda_min</span><span class=p>;</span> <span class=n>lambda</span> <span class=o>&lt;=</span> <span class=n>lambda_max</span><span class=p>;</span> <span class=o>++</span><span class=n>lambda</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>values</span><span class=p>[</span><span class=n>lambda</span> <span class=o>-</span> <span class=n>lambda_min</span><span class=p>]</span> <span class=o>=</span> <span class=n>spec</span><span class=p>(</span><span class=n>lambda</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">PiecewiseLinearSpectrum<div id=piecewiselinearspectrum class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#piecewiselinearspectrum aria-label=锚点>#</a></span></h4><p><code>PiecewiseLinearSpectrum</code>定义少量插值点再插值得到各个波长下的值,
对于部分区间比较平滑的分布这可以有效节省内存.
构造函数中会对插值点排序, 读取功率时<code>PiecewiseLinearSpectrum</code>找到对应区间并插值.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Float</span> <span class=n>PiecewiseLinearSpectrum</span><span class=o>::</span><span class=k>operator</span><span class=p>()(</span><span class=n>Float</span> <span class=n>lambda</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle _PiecewiseLinearSpectrum_ corner cases
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>lambdas</span><span class=p>.</span><span class=n>empty</span><span class=p>()</span> <span class=o>||</span> <span class=n>lambda</span> <span class=o>&lt;</span> <span class=n>lambdas</span><span class=p>.</span><span class=n>front</span><span class=p>()</span> <span class=o>||</span> <span class=n>lambda</span> <span class=o>&gt;</span> <span class=n>lambdas</span><span class=p>.</span><span class=n>back</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Find offset to largest _lambdas_ below _lambda_ and interpolate
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>o</span> <span class=o>=</span> <span class=n>FindInterval</span><span class=p>(</span><span class=n>lambdas</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>](</span><span class=kt>int</span> <span class=n>i</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=n>lambdas</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>lambda</span><span class=p>;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=n>DCHECK</span><span class=p>(</span><span class=n>lambda</span> <span class=o>&gt;=</span> <span class=n>lambdas</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=n>lambda</span> <span class=o>&lt;=</span> <span class=n>lambdas</span><span class=p>[</span><span class=n>o</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>Float</span> <span class=n>t</span> <span class=o>=</span> <span class=p>(</span><span class=n>lambda</span> <span class=o>-</span> <span class=n>lambdas</span><span class=p>[</span><span class=n>o</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>lambdas</span><span class=p>[</span><span class=n>o</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>lambdas</span><span class=p>[</span><span class=n>o</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>Lerp</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>values</span><span class=p>[</span><span class=n>o</span><span class=p>],</span> <span class=n>values</span><span class=p>[</span><span class=n>o</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">BlackbodySpectrum<div id=blackbodyspectrum class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#blackbodyspectrum aria-label=锚点>#</a></span></h4><p><code>BlackbodySpectrum</code>通过温度构造, 由于黑体光谱中功率过大采样时会通过最大功率值归一化.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=nf>BlackbodySpectrum</span><span class=p>(</span><span class=n>Float</span> <span class=n>T</span><span class=p>)</span> <span class=o>:</span> <span class=n>T</span><span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute blackbody normalization constant for given temperature
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Float</span> <span class=n>lambdaMax</span> <span class=o>=</span> <span class=mf>2.8977721e-3</span><span class=n>f</span> <span class=o>/</span> <span class=n>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>normalizationFactor</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>Blackbody</span><span class=p>(</span><span class=n>lambdaMax</span> <span class=o>*</span> <span class=mf>1e9</span><span class=n>f</span><span class=p>,</span> <span class=n>T</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=n>Float</span> <span class=nf>operator</span><span class=p>()(</span><span class=n>Float</span> <span class=n>lambda</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Blackbody</span><span class=p>(</span><span class=n>lambda</span><span class=p>,</span> <span class=n>T</span><span class=p>)</span> <span class=o>*</span> <span class=n>normalizationFactor</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">嵌入光谱数据<div id=%E5%B5%8C%E5%85%A5%E5%85%89%E8%B0%B1%E6%95%B0%E6%8D%AE class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%B5%8C%E5%85%A5%E5%85%89%E8%B0%B1%E6%95%B0%E6%8D%AE aria-label=锚点>#</a></span></h3><p>部分常见的光谱分布可以直接通过字符串获取, 例如<code>DenselySampledSpectrum</code>类型的D65光源.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Spectrum</span> <span class=nf>GetNamedSpectrum</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>name</span><span class=p>);</span>
</span></span></code></pre></div><h3 class="relative group">采样光谱分布<div id=%E9%87%87%E6%A0%B7%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%87%87%E6%A0%B7%E5%85%89%E8%B0%B1%E5%88%86%E5%B8%83 aria-label=锚点>#</a></span></h3><p>pbrt不提供复杂的积分计算功能, 但是会提供采样函数以执行Monte Carlo积分.
相比于传统的RGB渲染使用3个固定的波长, pbrt默认会采样4个不同的波长.</p><h4 class="relative group">SampledSpectrum<div id=sampledspectrum class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sampledspectrum aria-label=锚点>#</a></span></h4><p><code>SampledSpectrum</code>用于存储多个采样样本.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>explicit</span> <span class=nf>SampledSpectrum</span><span class=p>(</span><span class=n>Float</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span> <span class=n>values</span><span class=p>.</span><span class=n>fill</span><span class=p>(</span><span class=n>c</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>SampledSpectrum</span><span class=p>(</span><span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Float</span><span class=o>&gt;</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>pbrt提供bool重载使得采样值全为0时可以跳过计算.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>explicit</span> <span class=k>operator</span> <span class=nf>bool</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>pbrt支持逐样本数学计算, 例如加法.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>SampledSpectrum</span> <span class=o>&amp;</span><span class=k>operator</span><span class=o>+=</span><span class=p>(</span><span class=k>const</span> <span class=n>SampledSpectrum</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>s</span><span class=p>.</span><span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">SampledWavelengths<div id=sampledwavelengths class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sampledwavelengths aria-label=锚点>#</a></span></h4><p><code>SampledWavelengths</code>会存储每个样本的采样波长与概率密度,
与<code>SampledSpectrum</code>分开存储主要是因为<code>SampledSpectrum</code>在渲染过程中(尤其是GPU)需要大量创建,
分离出去可以减小对象的内存占用. 同时, 经过一段时间的开发后, pbrt的作者发现混合不同波长的计算并不会导致bug.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>pstd</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=n>Float</span><span class=p>,</span> <span class=n>NSpectrumSamples</span><span class=o>&gt;</span> <span class=n>lambda</span><span class=p>,</span> <span class=n>pdf</span><span class=p>;</span>
</span></span></code></pre></div><p>最基础的均匀采样如下.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>SampledWavelengths</span> <span class=nf>SampleUniform</span><span class=p>(</span><span class=n>Float</span> <span class=n>u</span><span class=p>,</span> <span class=n>Float</span> <span class=n>lambda_min</span> <span class=o>=</span> <span class=n>Lambda_min</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>Float</span> <span class=n>lambda_max</span> <span class=o>=</span> <span class=n>Lambda_max</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledWavelengths</span> <span class=n>swl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Sample first wavelength using _u_
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>swl</span><span class=p>.</span><span class=n>lambda</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>Lerp</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>lambda_min</span><span class=p>,</span> <span class=n>lambda_max</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Initialize _lambda_ for remaining wavelengths
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Float</span> <span class=n>delta</span> <span class=o>=</span> <span class=p>(</span><span class=n>lambda_max</span> <span class=o>-</span> <span class=n>lambda_min</span><span class=p>)</span> <span class=o>/</span> <span class=n>NSpectrumSamples</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>swl</span><span class=p>.</span><span class=n>lambda</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>swl</span><span class=p>.</span><span class=n>lambda</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>delta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>swl</span><span class=p>.</span><span class=n>lambda</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>lambda_max</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>swl</span><span class=p>.</span><span class=n>lambda</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>lambda_min</span> <span class=o>+</span> <span class=p>(</span><span class=n>swl</span><span class=p>.</span><span class=n>lambda</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>lambda_max</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute PDF for sampled wavelengths
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>swl</span><span class=p>.</span><span class=n>pdf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>lambda_max</span> <span class=o>-</span> <span class=n>lambda_min</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>swl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>散射可能导致不同波长的光具有不同的传播路径, pbrt支持只保留一个样本继续传播光线.
由于这些样本都遵循相同的分布, pbrt保留第0个样本即可. 类似于俄罗斯轮盘,
保留的样本的概率密度会乘上它在这个过程中存活的概率<code>1 / NSpectrumSamples</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>TerminateSecondary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>SecondaryTerminated</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Update wavelength probabilities for termination
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pdf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pdf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>/=</span> <span class=n>NSpectrumSamples</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>SecondaryTerminated</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NSpectrumSamples</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pdf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">颜色<div id=%E9%A2%9C%E8%89%B2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%A2%9C%E8%89%B2 aria-label=锚点>#</a></span></h2><p>与光谱分布相比, 颜色会更多的考虑人眼的感知, 而非单纯的物理量.
pbrt基于光谱分布而非颜色, 但是由于处理渲染图像输出、部分场景描述使用颜色来表示反射率等信息等原因,
pbrt需要正确的处理颜色与光谱分布的转换.</p><p>三刺激理论中使用三个光谱匹配函数计算得到的刺激值即可表示颜色, 这三个值构成了3D的色彩空间.
由于刺激值由积分得到, 在色彩空间中颜色的加法与缩放是允许的, 但是颜色之间并不能相乘, 这也是RGB渲染的问题之一.
匹配积分如下, S为光谱分布, \(m_{1,2,3}\)为三刺激理论中RGB对应的波长各自的匹配函数.</p><p>$$
\begin{equation}
v_i = \int_\lambda S(\lambda)m_i(\lambda)d\lambda
\end{equation}
$$</p><h3 class="relative group">XYZ色彩空间<div id=xyz%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#xyz%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 aria-label=锚点>#</a></span></h3><p>CIE通过大量实验定义了RGB色彩空间, 由于有负值, 经过变换后得到XYZ色彩空间.
XYZ色彩空间是设备无关的, 通常用于色彩空间转换的中介.</p><p>pbrt中使用Y归一化后的色彩值. Y上的匹配函数与用于计算亮度的光谱响应曲线成正比,
满足\(V(\lambda) = 683 Y(\lambda)\).</p><p>$$
\begin{equation}
\begin{aligned}
x_\lambda &= \frac{\int_\lambda S(\lambda)X(\lambda)d\lambda}{\int_\lambda Y(\lambda)d\lambda}\\
y_\lambda &= \frac{\int_\lambda S(\lambda)Y(\lambda)d\lambda}{\int_\lambda Y(\lambda)d\lambda}\\
z_\lambda &= \frac{\int_\lambda S(\lambda)Z(\lambda)d\lambda}{\int_\lambda Y(\lambda)d\lambda}
\end{aligned}
\end{equation}
$$</p><p>pbrt支持获取X、Y、Z对应的<code>DenselySampledSpectrum</code>类型的光谱分布.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>namespace</span> <span class=n>Spectra</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>DenselySampledSpectrum</span> <span class=o>&amp;</span><span class=n>X</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>DenselySampledSpectrum</span> <span class=o>&amp;</span><span class=n>Y</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>DenselySampledSpectrum</span> <span class=o>&amp;</span><span class=n>Z</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>pbrt支持通过计算积分将光谱分布转化为XYZ空间的颜色.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>XYZ</span> <span class=nf>SpectrumToXYZ</span><span class=p>(</span><span class=n>Spectrum</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>XYZ</span><span class=p>(</span><span class=n>InnerProduct</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Spectra</span><span class=o>::</span><span class=n>X</span><span class=p>(),</span> <span class=n>s</span><span class=p>),</span>
</span></span><span class=line><span class=cl>               <span class=n>InnerProduct</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Spectra</span><span class=o>::</span><span class=n>Y</span><span class=p>(),</span> <span class=n>s</span><span class=p>),</span>
</span></span><span class=line><span class=cl>               <span class=n>InnerProduct</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Spectra</span><span class=o>::</span><span class=n>Z</span><span class=p>(),</span> <span class=n>s</span><span class=p>))</span> <span class=o>/</span> <span class=n>CIE_Y_integral</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>SampledSpectrum</code>可以通过Monte Carlo转化为XYZ(感觉样本不太够).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>XYZ</span> <span class=n>SampledSpectrum</span><span class=o>::</span><span class=n>ToXYZ</span><span class=p>(</span><span class=k>const</span> <span class=n>SampledWavelengths</span> <span class=o>&amp;</span><span class=n>lambda</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Sample the $X$, $Y$, and $Z$ matching curves at _lambda_
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SampledSpectrum</span> <span class=n>X</span> <span class=o>=</span> <span class=n>Spectra</span><span class=o>::</span><span class=n>X</span><span class=p>().</span><span class=n>Sample</span><span class=p>(</span><span class=n>lambda</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=n>Y</span> <span class=o>=</span> <span class=n>Spectra</span><span class=o>::</span><span class=n>Y</span><span class=p>().</span><span class=n>Sample</span><span class=p>(</span><span class=n>lambda</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=n>Z</span> <span class=o>=</span> <span class=n>Spectra</span><span class=o>::</span><span class=n>Z</span><span class=p>().</span><span class=n>Sample</span><span class=p>(</span><span class=n>lambda</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Evaluate estimator to compute $(x,y,z)$ coefficients
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SampledSpectrum</span> <span class=n>pdf</span> <span class=o>=</span> <span class=n>lambda</span><span class=p>.</span><span class=n>PDF</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>XYZ</span><span class=p>(</span><span class=n>SafeDiv</span><span class=p>(</span><span class=n>X</span> <span class=o>*</span> <span class=o>*</span><span class=k>this</span><span class=p>,</span> <span class=n>pdf</span><span class=p>).</span><span class=n>Average</span><span class=p>(),</span> <span class=n>SafeDiv</span><span class=p>(</span><span class=n>Y</span> <span class=o>*</span> <span class=o>*</span><span class=k>this</span><span class=p>,</span> <span class=n>pdf</span><span class=p>).</span><span class=n>Average</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>               <span class=n>SafeDiv</span><span class=p>(</span><span class=n>Z</span> <span class=o>*</span> <span class=o>*</span><span class=k>this</span><span class=p>,</span> <span class=n>pdf</span><span class=p>).</span><span class=n>Average</span><span class=p>())</span> <span class=o>/</span>
</span></span><span class=line><span class=cl>           <span class=n>CIE_Y_integral</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">xyY色彩空间<div id=xyy%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#xyy%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 aria-label=锚点>#</a></span></h3><p>颜色可以被分离为亮度(lightness, 不是luminance)与色度(chroma),
色度通过投影到\(x+y+z=1\)平面即可得到, 投影后为舌状图.</p><p>$$
\begin{equation}
\begin{aligned}
x &= \frac{x_\lambda}{x_\lambda + y_\lambda + z_\lambda}\\
y &= \frac{y_\lambda}{x_\lambda + y_\lambda + z_\lambda}\\
Y &= x_\lambda + y_\lambda + z_\lambda
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">RGB颜色<div id=rgb%E9%A2%9C%E8%89%B2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#rgb%E9%A2%9C%E8%89%B2 aria-label=锚点>#</a></span></h3><p>每个显示器都具有不同的RGB响应曲线 在RGB响应曲线已知的情况下,
可以利用XYZ空间得到色彩变换矩阵. 下式以红色为例展示了这一转换的过程.</p><p>$$
\begin{equation}
\begin{aligned}
r
&= \int_\lambda R(\lambda)S(\lambda)d\lambda\\
&= \int_\lambda R(\lambda)(x_\lambda X(\lambda) + y_\lambda Y(\lambda) + z_\lambda Z(\lambda)) d\lambda\\
&= x_\lambda \int_\lambda R(\lambda) X(\lambda) d\lambda + y_\lambda \int_\lambda R(\lambda) Y(\lambda) d\lambda + z_\lambda \int_\lambda R(\lambda) Z(\lambda) d\lambda
\end{aligned}
\end{equation}
$$</p><p>$$
\begin{equation}
\begin{bmatrix}
r\\
g\\
b
\end{bmatrix} =
\begin{pmatrix}
\int_\lambda R(\lambda) X(\lambda)d\lambda & \int_\lambda R(\lambda) Y(\lambda)d\lambda & \int_\lambda R(\lambda) Z(\lambda)d\lambda\\
\int_\lambda G(\lambda) X(\lambda)d\lambda & \int_\lambda G(\lambda) Y(\lambda)d\lambda & \int_\lambda G(\lambda) Z(\lambda)d\lambda\\
\int_\lambda B(\lambda) X(\lambda)d\lambda & \int_\lambda B(\lambda) Y(\lambda)d\lambda & \int_\lambda B(\lambda) Z(\lambda)d\lambda
\end{pmatrix}
\begin{bmatrix}
x_\lambda\\
y_\lambda\\
z_\lambda
\end{bmatrix}
\end{equation}
$$</p><h3 class="relative group">RGB色彩空间<div id=rgb%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#rgb%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 aria-label=锚点>#</a></span></h3><p>某种响应曲线对应下三原色(R为当前响应曲线下的(1, 0, 0)对应的颜色, G、B同理)的色度在色度图上构成的三角形就是RGB色彩空间.
该色彩空间下三色值为1的颜色在色度图上的色度为白点, 由于人眼感知的问题白色通常在短波具有更高的功率, 一般选用D65作为白点.</p><p><code>RGBColorSpace</code>的构造需要提供白色光照对应的光谱分布, 以便于后续用户通过RGB指定光源颜色.
同时由于R、G、B的色度已知, 可以得到Y=1下它们对应的XYZ颜色.
结合白色光照的XYZ颜色, 此时只有三原色的亮度信息是缺失的,
即下式中的常数, 可以在构造函数中计算出来.
以XYZ空间为中转可以实现快速的颜色空间转换.</p><p>$$
\begin{equation}
\begin{bmatrix}
w_x \\
w_y \\
w_z \\
\end{bmatrix} =
\begin{pmatrix}
r_x & g_x & b_x\\
r_y & g_y & b_y\\
r_z & g_z & b_z
\end{pmatrix}
\begin{pmatrix}
c_x & 0 & 0\\
0 & c_y & 0\\
0 & 0 & c_z
\end{pmatrix}
\begin{bmatrix}
1\\
1\\
1
\end{bmatrix}
\end{equation}
$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>RGBColorSpace</span><span class=o>::</span><span class=n>RGBColorSpace</span><span class=p>(</span><span class=n>Point2f</span> <span class=n>r</span><span class=p>,</span> <span class=n>Point2f</span> <span class=n>g</span><span class=p>,</span> <span class=n>Point2f</span> <span class=n>b</span><span class=p>,</span> <span class=n>Spectrum</span> <span class=n>illuminant</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=k>const</span> <span class=n>RGBToSpectrumTable</span> <span class=o>*</span><span class=n>rgbToSpec</span><span class=p>,</span> <span class=n>Allocator</span> <span class=n>alloc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=n>r</span><span class=p>(</span><span class=n>r</span><span class=p>),</span> <span class=n>g</span><span class=p>(</span><span class=n>g</span><span class=p>),</span> <span class=n>b</span><span class=p>(</span><span class=n>b</span><span class=p>),</span> <span class=n>illuminant</span><span class=p>(</span><span class=n>illuminant</span><span class=p>,</span> <span class=n>alloc</span><span class=p>),</span> <span class=n>rgbToSpectrumTable</span><span class=p>(</span><span class=n>rgbToSpec</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute whitepoint primaries and XYZ coordinates
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>XYZ</span> <span class=n>W</span> <span class=o>=</span> <span class=n>SpectrumToXYZ</span><span class=p>(</span><span class=n>illuminant</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>W</span><span class=p>.</span><span class=n>xy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>XYZ</span> <span class=n>R</span> <span class=o>=</span> <span class=n>XYZ</span><span class=o>::</span><span class=n>FromxyY</span><span class=p>(</span><span class=n>r</span><span class=p>),</span> <span class=n>G</span> <span class=o>=</span> <span class=n>XYZ</span><span class=o>::</span><span class=n>FromxyY</span><span class=p>(</span><span class=n>g</span><span class=p>),</span> <span class=n>B</span> <span class=o>=</span> <span class=n>XYZ</span><span class=o>::</span><span class=n>FromxyY</span><span class=p>(</span><span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Initialize XYZ color space conversion matrices
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SquareMatrix</span><span class=o>&lt;</span><span class=mi>3</span><span class=o>&gt;</span> <span class=n>rgb</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>G</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>B</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>R</span><span class=p>.</span><span class=n>Y</span><span class=p>,</span> <span class=n>G</span><span class=p>.</span><span class=n>Y</span><span class=p>,</span> <span class=n>B</span><span class=p>.</span><span class=n>Y</span><span class=p>,</span> <span class=n>R</span><span class=p>.</span><span class=n>Z</span><span class=p>,</span> <span class=n>G</span><span class=p>.</span><span class=n>Z</span><span class=p>,</span> <span class=n>B</span><span class=p>.</span><span class=n>Z</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>XYZ</span> <span class=n>C</span> <span class=o>=</span> <span class=n>InvertOrExit</span><span class=p>(</span><span class=n>rgb</span><span class=p>)</span> <span class=o>*</span> <span class=n>W</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>XYZFromRGB</span> <span class=o>=</span> <span class=n>rgb</span> <span class=o>*</span> <span class=n>SquareMatrix</span><span class=o>&lt;</span><span class=mi>3</span><span class=o>&gt;::</span><span class=n>Diag</span><span class=p>(</span><span class=n>C</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>C</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>C</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>RGBFromXYZ</span> <span class=o>=</span> <span class=n>InvertOrExit</span><span class=p>(</span><span class=n>XYZFromRGB</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">标准色彩空间<div id=%E6%A0%87%E5%87%86%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%A0%87%E5%87%86%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4 aria-label=锚点>#</a></span></h4><p>常见的色彩空间如下, 它们在pbrt中都被预定义了.</p><ol><li>sRGB, 90年代为Web标准颜色而开发, 目前应用最广泛</li><li>DCI-P3, 为数字影视行业开发, 色域广于sRGB, 应用逐渐扩大(比如我写这篇文章的mba就默认P3色域)</li><li>Rec2020, 为UHDTV开发, 色域广于DCI-P3</li><li>ACES2065-1, 色彩空间范围超过色度图, 可用于长期数据存储, 不受行业发展的影响.</li></ol><h3 class="relative group">使用光谱渲染的原因<div id=%E4%BD%BF%E7%94%A8%E5%85%89%E8%B0%B1%E6%B8%B2%E6%9F%93%E7%9A%84%E5%8E%9F%E5%9B%A0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BD%BF%E7%94%A8%E5%85%89%E8%B0%B1%E6%B8%B2%E6%9F%93%E7%9A%84%E5%8E%9F%E5%9B%A0 aria-label=锚点>#</a></span></h3><p>RGB色彩空间中颜色相乘不等于对应的光谱相乘, 例如用RGB表示入射光与反射率时得到的漫反射颜色是不正确的.
提到的另一点强调光谱提供的波长信息可以更方便的对色散、薄膜干涉、微表面的衍射等现象建模,
这一点我感觉更重要.</p><h3 class="relative group">波长样本数的选择<div id=%E6%B3%A2%E9%95%BF%E6%A0%B7%E6%9C%AC%E6%95%B0%E7%9A%84%E9%80%89%E6%8B%A9 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B3%A2%E9%95%BF%E6%A0%B7%E6%9C%AC%E6%95%B0%E7%9A%84%E9%80%89%E6%8B%A9 aria-label=锚点>#</a></span></h3><p>由于每个像素会生成多个样本, 通常采样到不同的波长, 每个样本并不需要采样过多的波长.
经过数据分析简单场景下采样32个波长可以达到最优的效果, 而复杂场景下8个样本可以达到最优.
Monte Carlo下需要每个像素生成多个不同光线路径的样本来减小损失,
且Monte Carlo带来的损失要大于波长样本数造成的损失, 因此pbrt采用默认4个样本.</p><h3 class="relative group">RGB转光谱<div id=rgb%E8%BD%AC%E5%85%89%E8%B0%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#rgb%E8%BD%AC%E5%85%89%E8%B0%B1 aria-label=锚点>#</a></span></h3><p>光谱转RGB的过程是确定的, 但由于同色异谱等原因RGB转光谱要相对困难.
由于现有3D工具通常以RGB参数或纹理存储反射率、自发光等信息, RGB转光谱是一项重要的任务.</p><p>转换过程需要考虑3种光谱分布.</p><ol><li>发光光谱, 用于自发光光源, RGB取值范围是无界的</li><li>反射光谱, 用于描述可吸收光照的表面的反射率, 由于能量守恒RGB位于[0,1]中</li><li>无界光谱, 自发光之外的其他无界值, 如折射率与介质散射</li></ol><p>首先解决反射光谱转换, 它需要满足以下三点性质.</p><ol><li>一致性, 转换得到光谱可以通过一般方法转换为当前的RGB</li><li>光滑性, RGB值的微小变动应该也对应光谱的微小变动</li><li>能量守恒</li></ol><p>pbrt使用2次多项式对光谱建模, 利用sigmoid函数保持能量守恒.
由于sigmoid函数的特征, 反射率为0与1需要特殊处理.</p><p>$$
\begin{equation}
\begin{aligned}
s(x) &= \frac{1}{2} + \frac{x}{2 \sqrt{1 + x^2}}\\
S(\lambda) &= s(c_2 \lambda^2 + c_1 \lambda + c_0)\\
\end{aligned}
\end{equation}
$$</p><p>pbrt通过数值优化来求解参数, 优化方程中加入白点是为了保证在三原色上具有均匀分布.
pbrt选用CIE76\(\Delta E\)作为优化范式, 利用Gauss-Newton方法求解.</p><p>$$
\begin{equation}
(c_0^*, c_1^*, c_2^*) = \underset{c_0,c_1,c_2} {\operatorname{argmin}}
\left\Vert
\begin{bmatrix}
r\\
g\\
b
\end{bmatrix} -
\int
\begin{bmatrix}
R(\lambda)\\
G(\lambda)\\
G(\lambda)
\end{bmatrix}
S(\lambda, c_0, c_1, c_2)
W(\lambda)
d\lambda
\right\Vert
\end{equation}
$$</p><p>为了使插值更平滑, 根据对色彩空间中参数梯度变化, pbrt根据RGB哪个值最大来决定要查的表.
例如当R最大时会把颜色做如下的转换. x、y在表中的位置是线性的, z因为在0与1附近变化最大,
是非线性的, 需要通过二分找到在表中的位置.</p><p>$$
\begin{equation}
(x,y,z)=(\frac{g}{r}, \frac{b}{r}, r)
\end{equation}
$$</p><p>此时我们可以定义<code>RGBAlbedoSpectrum</code>, 构造函数通过颜色来得到反射率分布.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>RGBAlbedoSpectrum</span><span class=o>::</span><span class=n>RGBAlbedoSpectrum</span><span class=p>(</span><span class=k>const</span> <span class=n>RGBColorSpace</span> <span class=o>&amp;</span><span class=n>cs</span><span class=p>,</span> <span class=n>RGB</span> <span class=n>rgb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>rsp</span> <span class=o>=</span> <span class=n>cs</span><span class=p>.</span><span class=n>ToRGBCoeffs</span><span class=p>(</span><span class=n>rgb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">无界光谱<div id=%E6%97%A0%E7%95%8C%E5%85%89%E8%B0%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%97%A0%E7%95%8C%E5%85%89%E8%B0%B1 aria-label=锚点>#</a></span></h4><p>无界光谱定义在<code>RGBUnboundedSpectrum</code>中, 通过将最大值归一化为\(\frac{1}{2}\)来提升参数优化的效果.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>RGBUnboundedSpectrum</span><span class=o>::</span><span class=n>RGBUnboundedSpectrum</span><span class=p>(</span><span class=k>const</span> <span class=n>RGBColorSpace</span> <span class=o>&amp;</span><span class=n>cs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                           <span class=n>RGB</span> <span class=n>rgb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Float</span> <span class=n>m</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>({</span><span class=n>rgb</span><span class=p>.</span><span class=n>r</span><span class=p>,</span> <span class=n>rgb</span><span class=p>.</span><span class=n>g</span><span class=p>,</span> <span class=n>rgb</span><span class=p>.</span><span class=n>b</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=n>scale</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>rsp</span> <span class=o>=</span> <span class=n>cs</span><span class=p>.</span><span class=n>ToRGBCoeffs</span><span class=p>(</span><span class=n>scale</span> <span class=o>?</span> <span class=n>rgb</span> <span class=o>/</span> <span class=nl>scale</span> <span class=p>:</span> <span class=n>RGB</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>Float</span> <span class=n>RGBUnboundedSpectrum</span><span class=o>::</span><span class=k>operator</span><span class=p>()(</span><span class=n>Float</span> <span class=n>lambda</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>scale</span> <span class=o>*</span> <span class=nf>rsp</span><span class=p>(</span><span class=n>lambda</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>Float</span> <span class=n>RGBUnboundedSpectrum</span><span class=o>::</span><span class=n>MaxValue</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>scale</span> <span class=o>*</span> <span class=n>rsp</span><span class=p>.</span><span class=n>MaxValue</span><span class=p>();</span> <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">自发光光谱<div id=%E8%87%AA%E5%8F%91%E5%85%89%E5%85%89%E8%B0%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%87%AA%E5%8F%91%E5%85%89%E5%85%89%E8%B0%B1 aria-label=锚点>#</a></span></h4><p>自发光光谱定义在<code>RGBIlluminantSpectrum</code>中, 在<code>RGBUnboundedSpectrum</code>的基础上,
自发光光源在取值时会乘上当前色彩空间的标准光源在该波长下的值,
这是为了模拟人眼对颜色的自适应, 或者说白平衡.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>RGBIlluminantSpectrum</span><span class=o>::</span><span class=n>RGBIlluminantSpectrum</span><span class=p>(</span><span class=k>const</span> <span class=n>RGBColorSpace</span> <span class=o>&amp;</span><span class=n>cs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                             <span class=n>RGB</span> <span class=n>rgb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=n>illuminant</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cs</span><span class=p>.</span><span class=n>illuminant</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Float</span> <span class=n>m</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>({</span><span class=n>rgb</span><span class=p>.</span><span class=n>r</span><span class=p>,</span> <span class=n>rgb</span><span class=p>.</span><span class=n>g</span><span class=p>,</span> <span class=n>rgb</span><span class=p>.</span><span class=n>b</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=n>scale</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>rsp</span> <span class=o>=</span> <span class=n>cs</span><span class=p>.</span><span class=n>ToRGBCoeffs</span><span class=p>(</span><span class=n>scale</span> <span class=o>?</span> <span class=n>rgb</span> <span class=o>/</span> <span class=nl>scale</span> <span class=p>:</span> <span class=n>RGB</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>Float</span> <span class=n>RGBIlluminantSpectrum</span><span class=o>::</span><span class=k>operator</span><span class=p>()(</span><span class=n>Float</span> <span class=n>lambda</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>illuminant</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>scale</span> <span class=o>*</span> <span class=nf>rsp</span><span class=p>(</span><span class=n>lambda</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=o>*</span><span class=n>illuminant</span><span class=p>)(</span><span class=n>lambda</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">结语<div id=%E7%BB%93%E8%AF%AD class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BB%93%E8%AF%AD aria-label=锚点>#</a></span></h2><p>这章对辐射度量学与光谱渲染进行了详细的介绍, 反射模型相关内容也有涉及,
由于它直接影响渲染过程中光线传播显示的颜色, 后面第9章会有单独的章节细化这些内容.</p><p>RGB渲染只能说是光谱渲染的一个简化版本, 不过考虑到现有GPU架构,
光谱渲染应用在实时渲染应该还有一段距离, 积分的计算有点为难shader了.</p><p>另外, <code>TaggedPointer</code>这种显示指明子类的多态实现属实有点丑陋,
但不借助反射的话应该也没什么好方法了.</p></div></div><script>var oid="views_render/1728265562044-pbrt-v4-episode-4/index.md",oid_likes="likes_render/1728265562044-pbrt-v4-episode-4/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/render/1728092546418-pbrt-v4-episode-3/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">pbrt-v4 Ep. III: 几何与变换</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-10-05T00:00:00+00:00>2024 October 5</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/render/1730695131466-pbrt-v4-episode-5/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">pbrt-v4 Ep. V: 相机模型</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-11-04T00:00:00+00:00>2024 November 4</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=tsssni/tsssni.github.io data-repo-id=R_kgDOMEzJ_g data-category=Announcements data-category-id=DIC_kwDOMEzJ_s4CgBEJ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://tsssni.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>