<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>pbrt-v4 Ep. IX: 反射模型 &#183; tsssni's blowfish blog</title>
<meta name=title content="pbrt-v4 Ep. IX: 反射模型 &#183; tsssni's blowfish blog"><meta name=description content="pbrt-v4 episode 9"><meta name=keywords content="graphics,rendering,pbrt,"><link rel=canonical href=https://tsssni.github.io/render/1733816209202-pbrt-v4-episode-9/><link type=text/css rel=stylesheet href=/css/main.bundle.min.3c451cff13adc9f03ed84ad472bed71f3ce32af0a5a02c86a92488a46f39d2132c8b77415cba5d090209aa152c39f494955da5508be718dd24dee647d4a5eb5f.css integrity="sha512-PEUc/xOtyfA+2ErUcr7XHzzjKvCloCyGqSSIpG850hMsi3dBXLpdCQIJqhUsOfSUlV2lUIvnGN0k3uZH1KXrXw=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.b6411b5d4cd56c0068d34c4acbce043846adad56b824e3d486a06d3459aed2eb7f7413874b7871cc2c822c8c8834cbed944022918bcc8cca710a962167c36d32.js integrity="sha512-tkEbXUzVbABo00xKy84EOEatrVa4JOPUhqBtNFmu0ut/dBOHS3hxzCyCLIyINMvtlEAikYvMjMpxCpYhZ8NtMg==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://tsssni.github.io/render/1733816209202-pbrt-v4-episode-9/"><meta property="og:site_name" content="tsssni's blowfish blog"><meta property="og:title" content="pbrt-v4 Ep. IX: 反射模型"><meta property="og:description" content="pbrt-v4 episode 9"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="render"><meta property="article:published_time" content="2024-12-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-10T00:00:00+00:00"><meta property="article:tag" content="Graphics"><meta property="article:tag" content="Rendering"><meta property="article:tag" content="Pbrt"><meta property="og:image" content="https://tsssni.github.io/render/1733816209202-pbrt-v4-episode-9/featured.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tsssni.github.io/render/1733816209202-pbrt-v4-episode-9/featured.jpg"><meta name=twitter:title content="pbrt-v4 Ep. IX: 反射模型"><meta name=twitter:description content="pbrt-v4 episode 9"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Rendering","name":"pbrt-v4 Ep. IX: 反射模型","headline":"pbrt-v4 Ep. IX: 反射模型","description":"pbrt-v4 episode 9","inLanguage":"zh-cn","url":"https:\/\/tsssni.github.io\/render\/1733816209202-pbrt-v4-episode-9\/","author":{"@type":"Person","name":""},"copyrightYear":"2024","dateCreated":"2024-12-10T00:00:00\u002b00:00","datePublished":"2024-12-10T00:00:00\u002b00:00","dateModified":"2024-12-10T00:00:00\u002b00:00","keywords":["graphics","rendering","pbrt"],"mainEntityOfPage":"true","wordCount":"11369"}]</script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link type=text/css rel=stylesheet href=/lib/katex/katex.min.8fee1bb91734542a6701c61b7be516ff2eb2df248bf4e4591aacc8f4e9df40c7ca9e9c0b3f657b166f5f13e69a8fb50a139b3babcef20aeeea18f0fbcd4169fb.css integrity="sha512-j+4buRc0VCpnAcYbe+UW/y6y3ySL9ORZGqzI9OnfQMfKnpwLP2V7Fm9fE+aaj7UKE5s7q87yCu7qGPD7zUFp+w=="><script defer src=/lib/katex/katex.min.8c68eaeb75cfdcfac071717a969e1b9d9230ad52c6a2ac21ff846eaf6a258364cbb79e5e3552e32c280faeb4f4eda4d7c5bd1492e30a961c737e1e5305300281.js integrity="sha512-jGjq63XP3PrAcXF6lp4bnZIwrVLGoqwh/4Rur2olg2TLt55eNVLjLCgPrrT07aTXxb0UkuMKlhxzfh5TBTACgQ=="></script><script defer src=/lib/katex/auto-render.min.e9b2833d28623d18c071d78ef13e9c79d695122d296af3dbcee7bf1bf6518b0565bab59939267fbc8f5faf696193c20f5caef3e7501969cfb306f6738032730d.js integrity="sha512-6bKDPShiPRjAcdeO8T6cedaVEi0pavPbzue/G/ZRiwVlurWZOSZ/vI9fr2lhk8IPXK7z51AZac+zBvZzgDJzDQ==" onload=renderMathInElement(document.body)></script><script data-id=umami-script async src=https://analytics.umami.is/script.js data-website-id=e54a34b7-b153-41c0-a794-bb050c0c1abc></script><script type=text/javascript>document.querySelector('script[data-id="umami-script"]').addEventListener("load",function(){const e=document.head.querySelector('meta[property = "og:type"]').getAttribute("content");let t=document.head.querySelector('meta[property = "og:title"]').getAttribute("content"),n=document.head.querySelector('meta[property = "og:url"]').getAttribute("content");umami.track(e+":"+t,{url:n})})</script><meta name=theme-color><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyAB04I5m3aWYDSR1j8C79UeKrBzVRF90Qg",authDomain:"AIzaSyAB04I5m3aWYDSR1j8C79UeKrBzVRF90Qg",projectId:"tsssni-s-blowfish-blog",storageBucket:"tsssni-s-blowfish-blog.appspot.com",messagingSenderId:"1044986167854",appId:"1:1044986167854:web:d5234c7787ec0a86e215bf",measurementId:"G-S2WG8P11SW"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">tsssni&rsquo;s blowfish blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/render/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Rendering>渲染</p></a><a href=/unix/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Unix>Unix</p></a><a href=/acgn/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=ACGN>ACGN</p></a><a href=/about/1717500731146-about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=关于>关于</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/render/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Rendering>渲染</p></a></li><li class=mt-1><a href=/unix/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Unix>Unix</p></a></li><li class=mt-1><a href=/acgn/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=ACGN>ACGN</p></a></li><li class=mt-1><a href=/about/1717500731146-about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=关于>关于</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="w-full rounded-md h-36 md:h-56 lg:h-72 single_hero_basic nozoom" style=background-image:url(/render/1733816209202-pbrt-v4-episode-9/featured_hu_422f55619d61e861.jpg)></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/plana-hero_hu_c87777a65a22491f.png)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-30 dark:opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">pbrt-v4 Ep. IX: 反射模型</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-12-10T00:00:00+00:00>2024 December 10</time><span class="px-2 text-primary-500">&#183;</span><span>11369 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>23 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_render/1733816209202-pbrt-v4-episode-9/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_render/1733816209202-pbrt-v4-episode-9/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400" onclick=process_article()>
<span id=button_likes_heart style=display:none class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg>
</span></span><span id=button_likes_text>&nbsp;Like</span></button></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/graphics/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Graphics
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/rendering/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Rendering
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/pbrt/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Pbrt</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#bsdf表示>BSDF表示</a><ul><li><a href=#几何设置与约定>几何设置与约定</a></li><li><a href=#bxdf接口>BxDF接口</a></li><li><a href=#半球反射>半球反射</a></li><li><a href=#bsdf中的delta分布>BSDF中的Delta分布</a></li><li><a href=#bsdf类>BSDF类</a></li></ul></li><li><a href=#漫反射>漫反射</a><ul><li><a href=#圆盘采样>圆盘采样</a></li><li><a href=#余弦加权半球采样>余弦加权半球采样</a></li></ul></li><li><a href=#镜面反射与透射>镜面反射与透射</a><ul><li><a href=#物理原理>物理原理</a></li><li><a href=#折射率>折射率</a></li><li><a href=#镜面反射法则>镜面反射法则</a></li><li><a href=#snell定律>Snell定律</a></li><li><a href=#fresnel方程>Fresnel方程</a></li><li><a href=#导体fresnel方程>导体Fresnel方程</a></li></ul></li><li><a href=#导体brdf>导体BRDF</a></li><li><a href=#绝缘体bsdf>绝缘体BSDF</a><ul><li><a href=#薄绝缘体bsdf>薄绝缘体BSDF</a></li><li><a href=#非对称散射与折射>非对称散射与折射</a></li></ul></li><li><a href=#微表面理论>微表面理论</a><ul><li><a href=#法线分布函数>法线分布函数</a></li><li><a href=#遮蔽函数>遮蔽函数</a></li><li><a href=#遮蔽阴影函数>遮蔽阴影函数</a></li><li><a href=#采样可见法线分布>采样可见法线分布</a></li><li><a href=#torrance-sparrow模型>Torrance-Sparrow模型</a><ul><li><a href=#半向量变换>半向量变换</a></li><li><a href=#torrance-sparrow-pdf>Torrance-Sparrow PDF</a></li><li><a href=#torrance-sparrow-brdf>Torrance-Sparrow BRDF</a></li><li><a href=#torrance-sparrow采样>Torrance-Sparrow采样</a></li></ul></li></ul></li><li><a href=#粗糙绝缘体bsdf>粗糙绝缘体BSDF</a><ul><li><a href=#粗糙绝缘体pdf>粗糙绝缘体PDF</a></li><li><a href=#粗糙绝缘体bsdf-1>粗糙绝缘体BSDF</a></li><li><a href=#粗糙绝缘体采样>粗糙绝缘体采样</a></li></ul></li><li><a href=#bsdf测量值>BSDF测量值</a><ul><li><a href=#测量过程>测量过程</a><ul><li><a href=#参数化测量>参数化测量</a></li><li><a href=#brdf求解>BRDF求解</a></li><li><a href=#泛化微表面模型>泛化微表面模型</a></li><li><a href=#初始微表面模型>初始微表面模型</a></li></ul></li><li><a href=#基础数据结构>基础数据结构</a></li><li><a href=#求解>求解</a></li></ul></li><li><a href=#毛发散射>毛发散射</a><ul><li><a href=#几何>几何</a></li><li><a href=#毛发散射-1>毛发散射</a></li><li><a href=#纵向散射>纵向散射</a></li><li><a href=#纤维吸收>纤维吸收</a></li><li><a href=#方位散射>方位散射</a></li><li><a href=#散射模型求解>散射模型求解</a><ul><li><a href=#可逆性>可逆性</a></li></ul></li><li><a href=#采样>采样</a></li><li><a href=#毛发吸收系数>毛发吸收系数</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#bsdf表示>BSDF表示</a><ul><li><a href=#几何设置与约定>几何设置与约定</a></li><li><a href=#bxdf接口>BxDF接口</a></li><li><a href=#半球反射>半球反射</a></li><li><a href=#bsdf中的delta分布>BSDF中的Delta分布</a></li><li><a href=#bsdf类>BSDF类</a></li></ul></li><li><a href=#漫反射>漫反射</a><ul><li><a href=#圆盘采样>圆盘采样</a></li><li><a href=#余弦加权半球采样>余弦加权半球采样</a></li></ul></li><li><a href=#镜面反射与透射>镜面反射与透射</a><ul><li><a href=#物理原理>物理原理</a></li><li><a href=#折射率>折射率</a></li><li><a href=#镜面反射法则>镜面反射法则</a></li><li><a href=#snell定律>Snell定律</a></li><li><a href=#fresnel方程>Fresnel方程</a></li><li><a href=#导体fresnel方程>导体Fresnel方程</a></li></ul></li><li><a href=#导体brdf>导体BRDF</a></li><li><a href=#绝缘体bsdf>绝缘体BSDF</a><ul><li><a href=#薄绝缘体bsdf>薄绝缘体BSDF</a></li><li><a href=#非对称散射与折射>非对称散射与折射</a></li></ul></li><li><a href=#微表面理论>微表面理论</a><ul><li><a href=#法线分布函数>法线分布函数</a></li><li><a href=#遮蔽函数>遮蔽函数</a></li><li><a href=#遮蔽阴影函数>遮蔽阴影函数</a></li><li><a href=#采样可见法线分布>采样可见法线分布</a></li><li><a href=#torrance-sparrow模型>Torrance-Sparrow模型</a><ul><li><a href=#半向量变换>半向量变换</a></li><li><a href=#torrance-sparrow-pdf>Torrance-Sparrow PDF</a></li><li><a href=#torrance-sparrow-brdf>Torrance-Sparrow BRDF</a></li><li><a href=#torrance-sparrow采样>Torrance-Sparrow采样</a></li></ul></li></ul></li><li><a href=#粗糙绝缘体bsdf>粗糙绝缘体BSDF</a><ul><li><a href=#粗糙绝缘体pdf>粗糙绝缘体PDF</a></li><li><a href=#粗糙绝缘体bsdf-1>粗糙绝缘体BSDF</a></li><li><a href=#粗糙绝缘体采样>粗糙绝缘体采样</a></li></ul></li><li><a href=#bsdf测量值>BSDF测量值</a><ul><li><a href=#测量过程>测量过程</a><ul><li><a href=#参数化测量>参数化测量</a></li><li><a href=#brdf求解>BRDF求解</a></li><li><a href=#泛化微表面模型>泛化微表面模型</a></li><li><a href=#初始微表面模型>初始微表面模型</a></li></ul></li><li><a href=#基础数据结构>基础数据结构</a></li><li><a href=#求解>求解</a></li></ul></li><li><a href=#毛发散射>毛发散射</a><ul><li><a href=#几何>几何</a></li><li><a href=#毛发散射-1>毛发散射</a></li><li><a href=#纵向散射>纵向散射</a></li><li><a href=#纤维吸收>纤维吸收</a></li><li><a href=#方位散射>方位散射</a></li><li><a href=#散射模型求解>散射模型求解</a><ul><li><a href=#可逆性>可逆性</a></li></ul></li><li><a href=#采样>采样</a></li><li><a href=#毛发吸收系数>毛发吸收系数</a></li></ul></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>pbrt将反射分为以下四类: 漫反射, 光滑镜面反射, 完美镜面反射, 回溯反射. 反射分布方程可以被分为各向同性与各向异性的, 若将物体旋转时在各个角度上具有相同的反射结果即位各向同性, 反之则为各向异性.</p><h2 class="relative group">BSDF表示<div id=bsdf%E8%A1%A8%E7%A4%BA class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bsdf%E8%A1%A8%E7%A4%BA aria-label=锚点>#</a></span></h2><p>pbrt中<code>BxDF</code>接口代表特定种类表面散射的实现, <code>BSDF</code>则是围绕<code>BxDF</code>指针做一层封装并提供额外功能.</p><h3 class="relative group">几何设置与约定<div id=%E5%87%A0%E4%BD%95%E8%AE%BE%E7%BD%AE%E4%B8%8E%E7%BA%A6%E5%AE%9A class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%87%A0%E4%BD%95%E8%AE%BE%E7%BD%AE%E4%B8%8E%E7%BA%A6%E5%AE%9A aria-label=锚点>#</a></span></h3><p>pbrt中法线计算发生在由表面的切线, 副切线与法线组成的坐标系中, 分别与\(x,y,z\)轴对齐. pbrt中光线入射方向与观察方向都会被归一化并方向朝外, 法线也始终朝外. 着色所用的坐标系很可能与相交所用的不同, 这便于实现法线映射等效果.</p><h3 class="relative group">BxDF接口<div id=bxdf%E6%8E%A5%E5%8F%A3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bxdf%E6%8E%A5%E5%8F%A3 aria-label=锚点>#</a></span></h3><p>单独的BRDF与BTDF方法都定义在<code>BxDF</code>接口中.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>class</span> <span class=nc>BxDF</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=k>public</span> <span class=n>TaggedPointer</span><span class=o>&lt;</span><span class=n>DiffuseTransmissionBxDF</span><span class=p>,</span> <span class=n>DiffuseBxDF</span><span class=p>,</span> <span class=n>CoatedDiffuseBxDF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>CoatedConductorBxDF</span><span class=p>,</span> <span class=n>DielectricBxDF</span><span class=p>,</span> <span class=n>ThinDielectricBxDF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>HairBxDF</span><span class=p>,</span> <span class=n>MeasuredBxDF</span><span class=p>,</span> <span class=n>ConductorBxDF</span><span class=p>,</span> <span class=n>NormalizedFresnelBxDF</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// BxDF Interface
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=n>BxDFFlags</span> <span class=n>Flags</span><span class=p>()</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>using</span> <span class=n>TaggedPointer</span><span class=o>::</span><span class=n>TaggedPointer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>ToString</span><span class=p>()</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=n>SampledSpectrum</span> <span class=nf>f</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>wi</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                          <span class=n>TransportMode</span> <span class=n>mode</span><span class=p>)</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=n>Sample_f</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>Float</span> <span class=n>uc</span><span class=p>,</span> <span class=n>Point2f</span> <span class=n>u</span><span class=p>,</span> <span class=n>TransportMode</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>TransportMode</span><span class=o>::</span><span class=n>Radiance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>BxDFReflTransFlags</span> <span class=n>sampleFlags</span> <span class=o>=</span> <span class=n>BxDFReflTransFlags</span><span class=o>::</span><span class=n>All</span><span class=p>)</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=n>Float</span> <span class=nf>PDF</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>wi</span><span class=p>,</span> <span class=n>TransportMode</span> <span class=n>mode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>BxDFReflTransFlags</span> <span class=n>sampleFlags</span> <span class=o>=</span> <span class=n>BxDFReflTransFlags</span><span class=o>::</span><span class=n>All</span><span class=p>)</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=nf>rho</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Float</span><span class=o>&gt;</span> <span class=n>uc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Point2f</span><span class=o>&gt;</span> <span class=n>u2</span><span class=p>)</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=nf>rho</span><span class=p>(</span><span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Point2f</span><span class=o>&gt;</span> <span class=n>u1</span><span class=p>,</span> <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Float</span><span class=o>&gt;</span> <span class=n>uc2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Point2f</span><span class=o>&gt;</span> <span class=n>u2</span><span class=p>)</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>Regularize</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><code>Flags</code>方法用于返回上文所述的材质类型以及区分反射与透射, 部分光线传播算法会通过该返回值决定行为.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>enum</span> <span class=nc>BxDFFlags</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Unset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Reflection</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Transmission</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Diffuse</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Glossy</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Specular</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Composite _BxDFFlags_ definitions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DiffuseReflection</span> <span class=o>=</span> <span class=n>Diffuse</span> <span class=o>|</span> <span class=n>Reflection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DiffuseTransmission</span> <span class=o>=</span> <span class=n>Diffuse</span> <span class=o>|</span> <span class=n>Transmission</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>GlossyReflection</span> <span class=o>=</span> <span class=n>Glossy</span> <span class=o>|</span> <span class=n>Reflection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>GlossyTransmission</span> <span class=o>=</span> <span class=n>Glossy</span> <span class=o>|</span> <span class=n>Transmission</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>SpecularReflection</span> <span class=o>=</span> <span class=n>Specular</span> <span class=o>|</span> <span class=n>Reflection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>SpecularTransmission</span> <span class=o>=</span> <span class=n>Specular</span> <span class=o>|</span> <span class=n>Transmission</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>All</span> <span class=o>=</span> <span class=n>Diffuse</span> <span class=o>|</span> <span class=n>Glossy</span> <span class=o>|</span> <span class=n>Specular</span> <span class=o>|</span> <span class=n>Reflection</span> <span class=o>|</span> <span class=n>Transmission</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><code>BxDF</code>的关键方法是<code>f</code>, 它根据方向返回BxDF的值, 方向需要位于前文所述的材质的本地空间中. <code>BxDF</code>接口认为不同波长的光是被解耦的, 某个波长上的能量不会被反射到不同的波长上, 因此<code>f</code>的返回值通过<code>SampledSpectrum</code>来表达. 荧光材质会在不同的波长间重新分布能量, 需要返回\(n \times n\)的矩阵来表示\(n\)个光谱样本之间的转移. <code>BxDF</code>的构造函数以及各种方法都没有<code>SampledSpectrum</code>中具体某个波长的信息, 这是不需要的. <code>TransportMode</code>用于表示出射方向是对着相机还是对着光源, 不对称散射会用到这一特性.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=n>SampledSpectrum</span> <span class=n>BxDF</span><span class=o>::</span><span class=n>f</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>wi</span><span class=p>,</span> <span class=n>TransportMode</span> <span class=n>mode</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>f</span> <span class=o>=</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>](</span><span class=k>auto</span> <span class=n>ptr</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>SampledSpectrum</span> <span class=p>{</span> <span class=k>return</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>wi</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>Dispatch</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>BxDF</code>还需要提供用于重要性抽样的方法, <code>Sample_f</code>用于实现这一任务. 由于光线路径是逆向构造的, 因此这里出射方向作为参数, 采样得到的入射方向. 参数中的<code>uc</code>与<code>u</code>用于实现一维与二维的采样, 通常<code>uc</code>用于选择反射或透射, <code>u</code>用于选择方向.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span> <span class=kr>inline</span> <span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=n>BxDF</span><span class=o>::</span><span class=n>Sample_f</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>Float</span> <span class=n>uc</span><span class=p>,</span> <span class=n>Point2f</span> <span class=n>u</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>TransportMode</span> <span class=n>mode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>BxDFReflTransFlags</span> <span class=n>sampleFlags</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>sample_f</span> <span class=o>=</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>](</span><span class=k>auto</span> <span class=n>ptr</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>Sample_f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>uc</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>sampleFlags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>Dispatch</span><span class=p>(</span><span class=n>sample_f</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>用户可以通过<code>sampleFlags</code>参数限制采样结果为透射或反射, 像在不透明表面采样透射样本的不合法采样会导致采样失效.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>enum</span> <span class=k>class</span> <span class=nc>BxDFReflTransFlags</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Unset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Reflection</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Transmission</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>All</span> <span class=o>=</span> <span class=n>Reflection</span> <span class=o>|</span> <span class=n>Transmission</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>若采样成功, BSDF的值, 入射方向, 分布密度以及对应的<code>flags</code>会被返回, 这里返回的<code>wi</code>位于本地空间中, 在<code>BSDF</code>中会转到渲染空间.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>struct</span> <span class=nc>BSDFSample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// BSDFSample Public Methods
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BSDFSample</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=nf>BSDFSample</span><span class=p>(</span><span class=n>SampledSpectrum</span> <span class=n>f</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>wi</span><span class=p>,</span> <span class=n>Float</span> <span class=n>pdf</span><span class=p>,</span> <span class=n>BxDFFlags</span> <span class=n>flags</span><span class=p>,</span> <span class=n>Float</span> <span class=n>eta</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=kt>bool</span> <span class=n>pdfIsProportional</span> <span class=o>=</span> <span class=nb>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=n>f</span><span class=p>(</span><span class=n>f</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>wi</span><span class=p>(</span><span class=n>wi</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>pdf</span><span class=p>(</span><span class=n>pdf</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>flags</span><span class=p>(</span><span class=n>flags</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>eta</span><span class=p>(</span><span class=n>eta</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>pdfIsProportional</span><span class=p>(</span><span class=n>pdfIsProportional</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>IsReflection</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>pbrt</span><span class=o>::</span><span class=n>IsReflective</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>IsTransmission</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>pbrt</span><span class=o>::</span><span class=n>IsTransmissive</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>IsDiffuse</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>pbrt</span><span class=o>::</span><span class=n>IsDiffuse</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>IsGlossy</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>pbrt</span><span class=o>::</span><span class=n>IsGlossy</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>IsSpecular</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>pbrt</span><span class=o>::</span><span class=n>IsSpecular</span><span class=p>(</span><span class=n>flags</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>ToString</span><span class=p>()</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Vector3f</span> <span class=n>wi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Float</span> <span class=n>pdf</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BxDFFlags</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Float</span> <span class=n>eta</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>pdfIsProportional</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 class="relative group">半球反射<div id=%E5%8D%8A%E7%90%83%E5%8F%8D%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8D%8A%E7%90%83%E5%8F%8D%E5%B0%84 aria-label=锚点>#</a></span></h3><p><code>rho</code>方法的两种重载分别用于计算第四章所介绍的半球-方向反射量与半球-半球反射量, 样本数量由调用者决定.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span> <span class=n>SampledSpectrum</span> <span class=n>BxDF</span><span class=o>::</span><span class=n>rho</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>wo</span><span class=p>,</span> <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Float</span><span class=o>&gt;</span> <span class=n>uc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Point2f</span><span class=o>&gt;</span> <span class=n>u2</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>wo</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=nf>r</span><span class=p>(</span><span class=mf>0.</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>DCHECK_EQ</span><span class=p>(</span><span class=n>uc</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>u2</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>uc</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute estimate of $\rho_\roman{hd}$
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=n>bs</span> <span class=o>=</span> <span class=n>Sample_f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>uc</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>u2</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>bs</span> <span class=o>&amp;&amp;</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>+=</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span> <span class=o>*</span> <span class=n>AbsCosTheta</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>)</span> <span class=o>/</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span> <span class=o>/</span> <span class=n>uc</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SampledSpectrum</span> <span class=n>BxDF</span><span class=o>::</span><span class=n>rho</span><span class=p>(</span><span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Point2f</span><span class=o>&gt;</span> <span class=n>u1</span><span class=p>,</span> <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Float</span><span class=o>&gt;</span> <span class=n>uc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>pstd</span><span class=o>::</span><span class=n>span</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>Point2f</span><span class=o>&gt;</span> <span class=n>u2</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DCHECK_EQ</span><span class=p>(</span><span class=n>uc</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>u1</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>DCHECK_EQ</span><span class=p>(</span><span class=n>u1</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>u2</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>SampledSpectrum</span> <span class=nf>r</span><span class=p>(</span><span class=mf>0.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>uc</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute estimate of $\rho_\roman{hh}$
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Vector3f</span> <span class=n>wo</span> <span class=o>=</span> <span class=n>SampleUniformHemisphere</span><span class=p>(</span><span class=n>u1</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>wo</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Float</span> <span class=n>pdfo</span> <span class=o>=</span> <span class=n>UniformHemispherePDF</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=n>bs</span> <span class=o>=</span> <span class=n>Sample_f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>uc</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>u2</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>bs</span> <span class=o>&amp;&amp;</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>+=</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span> <span class=o>*</span> <span class=n>AbsCosTheta</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>)</span> <span class=o>*</span> <span class=n>AbsCosTheta</span><span class=p>(</span><span class=n>wo</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>pdfo</span> <span class=o>*</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span> <span class=o>/</span> <span class=p>(</span><span class=n>Pi</span> <span class=o>*</span> <span class=n>uc</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">BSDF中的Delta分布<div id=bsdf%E4%B8%AD%E7%9A%84delta%E5%88%86%E5%B8%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bsdf%E4%B8%AD%E7%9A%84delta%E5%88%86%E5%B8%83 aria-label=锚点>#</a></span></h3><p>Delta分布主要用于完美镜面反射, 但是对于<code>Sample_f</code>与<code>PDF</code>方法, 返回Delta函数对应的无穷大密度在c++中是无法得到正确的渲染结果的. 对于<code>Sample_f</code>方法, 将Delta函数从PDF与BSDF分离, 可以发现Delta函数会被抵消, 由于PDF与Delta函数一致, 因此PDF设置为1即可. 对于<code>PDF</code>方法, 它的返回值为0, 因为恰好位于Delta函数对应的反射方向的概率过小.</p><p>$$
\begin{equation}
\frac{f_r(p, \omega_o, \omega_i)}{p(\omega_i)} = \frac{\delta(\omega&rsquo; - \omega_i)f_r^{\text{rem}}(p, \omega_o, \omega_i)}{\delta(\omega&rsquo; - \omega_i)p^{\text{rem}(\omega_i)}} = \frac{f_r^{\text{rem}}(p, \omega_o, \omega_i)}{p^{\text{rem}(\omega_i)}}
\end{equation}
$$</p><h3 class="relative group">BSDF类<div id=bsdf%E7%B1%BB class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bsdf%E7%B1%BB aria-label=锚点>#</a></span></h3><p><code>BSDF</code>主要用于处理从材质本地空间到渲染空间的转换. <code>BSDF</code>的构造函数会传入几何法线, 着色法线以及切线, <code>shadingFrame</code>用于存储着色所用的坐标系以及处理与渲染空间之间的转换.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>BSDF</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=nf>BSDF</span><span class=p>(</span><span class=n>Normal3f</span> <span class=n>ns</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>dpdus</span><span class=p>,</span> <span class=n>BxDF</span> <span class=n>bxdf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=n>bxdf</span><span class=p>(</span><span class=n>bxdf</span><span class=p>),</span> <span class=n>shadingFrame</span><span class=p>(</span><span class=n>Frame</span><span class=o>::</span><span class=n>FromXZ</span><span class=p>(</span><span class=n>Normalize</span><span class=p>(</span><span class=n>dpdus</span><span class=p>),</span> <span class=n>Vector3f</span><span class=p>(</span><span class=n>ns</span><span class=p>)))</span> <span class=p>{}</span>
</span></span></code></pre></div><p><code>BSDF</code>的<code>f</code>方法用于封装<code>BxDF</code>中的对应方法, 其中的模板版本用于在用户已知内部<code>BxDF</code>类型的情况下直接调用它的<code>f</code>方法, 这用于在GPU上避免pbrt中的动态方法分发.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=n>SampledSpectrum</span> <span class=nf>f</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>woRender</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>wiRender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>TransportMode</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>TransportMode</span><span class=o>::</span><span class=n>Radiance</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Vector3f</span> <span class=n>wi</span> <span class=o>=</span> <span class=n>RenderToLocal</span><span class=p>(</span><span class=n>wiRender</span><span class=p>),</span> <span class=n>wo</span> <span class=o>=</span> <span class=n>RenderToLocal</span><span class=p>(</span><span class=n>woRender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>wo</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>bxdf</span><span class=p>.</span><span class=n>f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>wi</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>BxDF</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span> <span class=n>SampledSpectrum</span> <span class=n>f</span><span class=p>(</span><span class=n>Vector3f</span> <span class=n>woRender</span><span class=p>,</span> <span class=n>Vector3f</span> <span class=n>wiRender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>TransportMode</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>TransportMode</span><span class=o>::</span><span class=n>Radiance</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Vector3f</span> <span class=n>wi</span> <span class=o>=</span> <span class=n>RenderToLocal</span><span class=p>(</span><span class=n>wiRender</span><span class=p>),</span> <span class=n>wo</span> <span class=o>=</span> <span class=n>RenderToLocal</span><span class=p>(</span><span class=n>woRender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>wo</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>BxDF</span> <span class=o>*</span><span class=n>specificBxDF</span> <span class=o>=</span> <span class=n>bxdf</span><span class=p>.</span><span class=n>CastOrNullptr</span><span class=o>&lt;</span><span class=n>BxDF</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>specificBxDF</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>wi</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>BSDF</code>的<code>Sample_f</code>会通过<code>std::optional</code>处理采样失效的情况.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=n>Sample_f</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Vector3f</span> <span class=n>woRender</span><span class=p>,</span> <span class=n>Float</span> <span class=n>u</span><span class=p>,</span> <span class=n>Point2f</span> <span class=n>u2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>TransportMode</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>TransportMode</span><span class=o>::</span><span class=n>Radiance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>BxDFReflTransFlags</span> <span class=n>sampleFlags</span> <span class=o>=</span> <span class=n>BxDFReflTransFlags</span><span class=o>::</span><span class=n>All</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Vector3f</span> <span class=n>wo</span> <span class=o>=</span> <span class=n>RenderToLocal</span><span class=p>(</span><span class=n>woRender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>wo</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=o>!</span><span class=p>(</span><span class=n>bxdf</span><span class=p>.</span><span class=n>Flags</span><span class=p>()</span> <span class=o>&amp;</span> <span class=n>sampleFlags</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Sample _bxdf_ and return _BSDFSample_
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>pstd</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>BSDFSample</span><span class=o>&gt;</span> <span class=n>bs</span> <span class=o>=</span> <span class=n>bxdf</span><span class=p>.</span><span class=n>Sample_f</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>u2</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>sampleFlags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>DCHECK_GE</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>bs</span> <span class=o>||</span> <span class=o>!</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span> <span class=o>||</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>PBRT_DBG</span><span class=p>(</span><span class=s>&#34;For wo = (%f, %f, %f), ns %f %f %f sampled f = %f %f %f %f, pdf = %f, &#34;</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;ratio[0] = %f wi = (%f, %f, %f)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>wo</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>wo</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>wo</span><span class=p>.</span><span class=n>z</span><span class=p>,</span> <span class=n>shadingFrame</span><span class=p>.</span><span class=n>z</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>shadingFrame</span><span class=p>.</span><span class=n>z</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>shadingFrame</span><span class=p>.</span><span class=n>z</span><span class=p>.</span><span class=n>z</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>?</span> <span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>f</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>/</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>pdf</span><span class=p>)</span> <span class=o>:</span> <span class=mi>0</span><span class=p>,</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span> <span class=o>=</span> <span class=n>LocalToRender</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>wi</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>bs</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">漫反射<div id=%E6%BC%AB%E5%8F%8D%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%BC%AB%E5%8F%8D%E5%B0%84 aria-label=锚点>#</a></span></h2><p>Lambertian反射模型是最简单的BRDF之一, 它表达了将入射光线均匀的反射到各个方向的完美漫反射. 大部分角度下Lambertian模型都可以很好的表达漫反射, 但是在与法线接近垂直的掠射角下镜面反射会导致明显的偏差.</p><p>Lambertian反射的表达式如下, 其中的\(\pi\)来自于积分得到的反射值. 在实时渲染中, 材质的反照率通常会预先乘上\(\pi\), 这避免了耗时的除法操作.</p><p>$$
\begin{equation}
\int_\omega f_r(p, \omega_o, \omega_i) \cos\theta d\omega = \int_0^{2\pi}\int_0^{\frac{\pi}{2}} \frac{R}{\pi} \cos\theta \sin\theta d\theta d\phi = R
\end{equation}
$$</p><p>pbrt在采样Lambertian时会将\(\cos\)项考虑进pdf中, 这使得分布不再均匀, 但能通过重要性抽样获得更好的渲染结果.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Sample cosine-weighted hemisphere to compute _wi_ and _pdf_
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Vector3f</span> <span class=n>wi</span> <span class=o>=</span> <span class=n>SampleCosineHemisphere</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>wo</span><span class=p>.</span><span class=n>z</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>wi</span><span class=p>.</span><span class=n>z</span> <span class=o>*=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Float</span> <span class=n>pdf</span> <span class=o>=</span> <span class=n>CosineHemispherePDF</span><span class=p>(</span><span class=n>AbsCosTheta</span><span class=p>(</span><span class=n>wi</span><span class=p>));</span>
</span></span></code></pre></div><h3 class="relative group">圆盘采样<div id=%E5%9C%86%E7%9B%98%E9%87%87%E6%A0%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9C%86%E7%9B%98%E9%87%87%E6%A0%B7 aria-label=锚点>#</a></span></h3><p>对极坐标\(r,\theta\)分别做重要性抽样会导致样本集中在圆盘中央, 因为虽然距离圆心距离的分布是均匀的, 由于不同半径下周长不同, 外侧点的分布会减少.</p><p>为了保证样本点在面积上均匀分布, 需要满足\(p(x,y)=\frac{1}{\pi}\), 使用Jacobi转为极坐标后可得\(p(r,\theta)=\frac{r}{\pi}\). 此时可以计算出如下PDF.</p><p>$$
\begin{equation}
\begin{aligned}
p(r)&=\int_0^{2\pi}p(r,\theta)d\theta=2r\\
p(\theta|r)&=\frac{p(r,\theta)}{p(r)}=\frac{1}{2\pi}
\end{aligned}
\end{equation}
$$</p><p>根据重要性抽样得到的结果如下, 此时根据Jacobian可得\(drd\theta=\frac{\pi}{\sqrt{x}}dxdy\), 均匀采样结果映射为圆盘采样结果时所占的面积并不均匀, 越靠近圆盘边缘所占面积越狭窄.</p><p>$$
\begin{equation}
\begin{aligned}
r&=\sqrt{\epsilon_1}\\
\theta&=2\pi\epsilon_2
\end{aligned}
\end{equation}
$$</p><p>Shirley-Chiu方法可以解决这一问题, 根据Cartesian轴及\(y=x,y=-x\)将\([-1,1]\)空间分为八个象限, 每个象限根据\(\max(x,y\))选出的轴是一致的, 长轴选取\(a\)点, 短轴选取\(b\)点, 需保证该\(\frac{ab}{2}\)面积的区域内的采样点在Cartesian及极坐标下所占面积成常数关系. 由于圆弧面积为\(\frac{\theta r^2}{2}\), 如下表达式可满足上述条件, 在极坐标中占的面积为\(\frac{\pi ab}{8}\), 看图片会更直观.</p><p>$$
\begin{equation}
\begin{aligned}
r&=
\begin{cases}
x & |x|>|y|\\
y & |x| \le |y|
\end{cases}\\
\theta&=
\begin{cases}
\frac{\pi}{4}\frac{y}{x} & |x| > |y|\\
\frac{\pi}{2} - \frac{x}{y} & |x| \le |y|
\end{cases}
\end{aligned}
\end{equation}
$$</p><p>此时Jacobian行列式满足如下关系, 因此\(p(r,\theta)=|J|^{-1}p(u,v)=|J|^{-1}\frac{1}{4}=\frac{r}{\pi}\).</p><p>$$
\begin{equation}
\begin{aligned}
|J|&=
\begin{cases}
\frac{\pi}{4x}=\frac{\pi}{4r} & |x|>|y|\\
\frac{\pi}{4y}=\frac{\pi}{4r} & |x|\le|y|
\end{cases}
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">余弦加权半球采样<div id=%E4%BD%99%E5%BC%A6%E5%8A%A0%E6%9D%83%E5%8D%8A%E7%90%83%E9%87%87%E6%A0%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BD%99%E5%BC%A6%E5%8A%A0%E6%9D%83%E5%8D%8A%E7%90%83%E9%87%87%E6%A0%B7 aria-label=锚点>#</a></span></h3><p>渲染方程中有余弦项, 将它与BSDF一起做重要性抽样可以有效的考虑余弦的影响, 例如减小与法线夹角较大的光线被采样到的概率. 令\(p(\omega)=c\cos\theta\), 此时可以得到如下关系.</p><p>$$
\begin{equation}
\begin{aligned}
&\int_\Theta p(\omega)d\omega=1\\
&\int_0^{2\pi}\int_0^{\frac{\pi}{2}}c\cos\theta\sin\theta d\theta d\phi=1\\
&amp;c=\frac{1}{\pi}\\
&amp;p(\theta,\phi)=\frac{1}{\pi}\cos\theta\sin\theta
\end{aligned}
\end{equation}
$$</p><p>Malley方法通过将均匀圆盘采样的结果投影到半球上实现重要性抽样. 由于此时\(r=\sin\theta\),将\(r,\phi\)转为\(\theta,\phi\)的Jacobian如下, 由此可得\(p(\theta,\phi)=p(r,\phi)\cos\theta=\frac{\sin\theta\cos\theta}{\pi}\), 满足重要性抽样的要求.</p><p>$$
\begin{equation}
\begin{aligned}
|J|=\begin{vmatrix}
\frac{\partial r}{\partial \theta} & \frac{\partial r}{\partial \phi}\\
\frac{\partial \phi}{\partial \theta} & \frac{\partial \phi}{\partial \phi}
\end{vmatrix}
=\begin{vmatrix}
\cos\theta & 0\\
0 & 1
\end{vmatrix}=\cos\theta
\end{aligned}
\end{equation}
$$</p><h2 class="relative group">镜面反射与透射<div id=%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E4%B8%8E%E9%80%8F%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E4%B8%8E%E9%80%8F%E5%B0%84 aria-label=锚点>#</a></span></h2><p>镜面反射只会将光线反射到某个方向集合中, 本节主要关注完美镜面反射, 微表面理论对反射结果的影响会在后面讨论.</p><h3 class="relative group">物理原理<div id=%E7%89%A9%E7%90%86%E5%8E%9F%E7%90%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%89%A9%E7%90%86%E5%8E%9F%E7%90%86 aria-label=锚点>#</a></span></h3><p>pbrt主要关注几何光学, 在波长远小于物体尺寸时这是可行的, 但对光的本质的探究也是必要的. 根据电磁学的定义光是电磁场的振荡, pbrt只关注其中电场的部分即电子的运动, 当光与表面接触时会刺激表面上的电子使其剧烈振荡, 移动的电子会导致电场中振荡的叠加.</p><p>依据电磁学理论, 物质可以分为绝缘体, 导体与半导体. 绝缘体中电子不会脱离原子; 导体中电子可以自由移动, 但移动过程中会有能量衰减, 通常完全吸收会发生在距离表面小于0.1微米处; 半导体兼顾二者的特性, 例如硅在可见光内具有金属特性, 在红外光中则具有透明特性.</p><h3 class="relative group">折射率<div id=%E6%8A%98%E5%B0%84%E7%8E%87 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%8A%98%E5%B0%84%E7%8E%87 aria-label=锚点>#</a></span></h3><p>由光所激发的电子产生的振荡通常会比原本的振荡的速度要小, 速度减小的程度被称为折射率(index of refraction, IOR), 它通过真空光速与当前材质中的光速的比值来定义, 通常在1.0~2.5之间, 同时光的波长也会影响IOR. IOR的突变会导致反射率的增加, IOR的变化是我们能观察到物体的原因.</p><h3 class="relative group">镜面反射法则<div id=%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E6%B3%95%E5%88%99 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E6%B3%95%E5%88%99 aria-label=锚点>#</a></span></h3><p>令入射光线方向为\(\omega_i\)(如上文所述, 方向是朝外的, 并非光线的传播方向), 完美反射的方向如下.</p><p>$$
\begin{equation}
\omega_r = -\omega_i + 2(\bold{n} \cdot \omega_i)\bold{n}
\end{equation}
$$</p><h3 class="relative group">Snell定律<div id=snell%E5%AE%9A%E5%BE%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#snell%E5%AE%9A%E5%BE%8B aria-label=锚点>#</a></span></h3><p>Snell定律描述了入射光线与折射光线在方向上的关系, 这可以通过Fermat原理推导得到, 即光的传播路径是耗时最小的路径, 通过求极值即可证明. 从Snell定律可以看出折射方向取决于IOR的比值即相对IOR, 后文中通过\(\eta\)表示该值.</p><p>$$
\begin{equation}
\begin{aligned}
\eta_i \sin\theta_i &= \eta_t \sin\theta_t\\
\phi_t &= \phi_i + \pi
\end{aligned}
\end{equation}
$$</p><p>经过不同介质后, 由于光的不同波长的部分具有不同的IOR, 这导致传播方向不同, 这被称为散射, 通常会表现为经过介质后产生彩虹状的光锥.</p><p>利用Snell定律可以按如下方式表示折射光线. 当光线从物体内部发出时, 由于法线朝外, \(\omega_i \cdot \bold{n}\)小于0, 需要对代码做适当调整.</p><p>$$
\begin{equation}
\omega_t = -\frac{\omega_i}{\eta} + \left[ \frac{\omega_i \cdot \bold{n}}{\eta} - \cos\theta_t \right] \bold{n}
\end{equation}
$$</p><p>当光线穿过光学密度更小(折射后的介质的IOR较小)时, 当入射天顶角超过\(\theta_c = \sin^{-1}(\eta^{-1})\)时折射天顶角会超过\(90^{\circ}\), 此时光线会完全反射.</p><h3 class="relative group">Fresnel方程<div id=fresnel%E6%96%B9%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fresnel%E6%96%B9%E7%A8%8B aria-label=锚点>#</a></span></h3><p>Fresnel方程描述了光线折射与反射的量, 它是Maxwell方程在光滑平面上的解.</p><p>将光线分解为相对于表面的垂直与水平偏振, 它们因反射而产生的振幅的变化是不同的. 若\(\theta_t>\frac{\pi}{2}\)可以认为是完全反射, Fresnel返回\(1\).</p><p>$$
\begin{equation}
\begin{aligned}
r_{||} &= \frac{E_r^{||}}{E_i^{||}} &= \frac{\eta_t \cos\theta_i - \eta_i \cos\theta_t}{\eta_t \cos\theta_i + \eta_i \cos\theta_t} &= \frac{\eta \cos\theta_i - \cos\theta_t}{\eta \cos\theta_i + \cos\theta_t}\\
r_{\perp} &= \frac{E_r^{\perp}}{E_i^{\perp}} &= \frac{\eta_i \cos\theta_i - \eta_t \cos\theta_t}{\eta_i \cos\theta_i + \eta_t \cos\theta_t} &= \frac{\cos\theta_i - \eta \cos\theta_t}{\cos\theta_i + \eta \cos\theta_t}
\end{aligned}
\end{equation}
$$</p><p>电磁学关注的是反射波的振幅与相位, 而pbrt的几何光学中更关注光线所携带的功率, 这可以通过振幅的平方来表示. 若入射光是无偏振的即含有等量的水平与垂直偏振, 此时反射功率为水平与垂直反射功率的平均值, 即位Fresnel反射率.</p><p>$$
\begin{equation}
F_r = \frac{1}{2}(r_{||}^2 + r_{\perp}^2)
\end{equation}
$$</p><p>实时渲染中通常使用Schlick近似.</p><p>$$
\begin{equation}
\begin{aligned}
F_r &= F_{r_0}+(1-F_{r_0})(1-\cos\theta_i)^5\\
F_{r_0} &= \left(\frac{\eta_i - \eta_t}{\eta_i + \eta_t}\right)^2
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">导体Fresnel方程<div id=%E5%AF%BC%E4%BD%93fresnel%E6%96%B9%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%AF%BC%E4%BD%93fresnel%E6%96%B9%E7%A8%8B aria-label=锚点>#</a></span></h3><p>导体的IOR需要用复数表示, 实部描述光线速度的减小, 虚部描述光线在材质内传播时的衰减.</p><p>虚部为\(0\)时电磁波振幅如下, 只关心Euler公式分解后的实部, 此时为与距离\(z\)相关的三角函数, \(\alpha\)代表空间频率.</p><p>$$
\begin{equation}
\begin{aligned}
E(z)&=e^{i\alpha\eta z}\\
\mathcal{R}(E(z))&=\cos(\alpha\eta z)
\end{aligned}
\end{equation}
$$</p><p>当使用复数\(\eta_c=\eta+ik\)表示IOR后, 电磁波振幅会随着传播距离衰减, 形式如下.</p><p>$$
\begin{equation}
\begin{aligned}
\mathcal{R}(E(z))=e^{-\alpha zk}\cos(\alpha\eta z)
\end{aligned}
\end{equation}
$$</p><p>复数的2范数为实部与虚部和的平方, 此时可泛化上述Fresnel反射率的计算.</p><p>$$
\begin{equation}
\begin{aligned}
||a+bi||_2=\sqrt{a^2+b^2}
\end{aligned}
\end{equation}
$$</p><h2 class="relative group">导体BRDF<div id=%E5%AF%BC%E4%BD%93brdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%AF%BC%E4%BD%93brdf aria-label=锚点>#</a></span></h2><p>本节描述的是从光从绝缘体介质中接触导体表面时的BRDF, 只考虑光滑的情况. 光滑导体只将光线返回到一个反向, 反射光线的辐亮度由Fresnel反射率决定, 因此BRDF如下.</p><p>$$
\begin{equation}
f_r(p, \omega_o, \omega_i) = F_r(\omega_r) \frac{\delta(\omega_i - \omega_r)}{|\cos\theta_r|}
\end{equation}
$$</p><h2 class="relative group">绝缘体BSDF<div id=%E7%BB%9D%E7%BC%98%E4%BD%93bsdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BB%9D%E7%BC%98%E4%BD%93bsdf aria-label=锚点>#</a></span></h2><p>pbrt在选择采样反射或透射时, 根据Fresnel反射率以及用户设置的Flags来决定. 由于只考虑光滑表面, BRDF和BTDF与上一节的导体BRDF都是相同的.</p><h3 class="relative group">薄绝缘体BSDF<div id=%E8%96%84%E7%BB%9D%E7%BC%98%E4%BD%93bsdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%96%84%E7%BB%9D%E7%BC%98%E4%BD%93bsdf aria-label=锚点>#</a></span></h3><p>pbrt通过<code>ThinDielectricBxDF</code>模拟光线穿过薄绝缘体平行的内外表面的现象, 由Fresnel反射率的定义可知, 若交换表面两侧的介质结果是不变的, 因此在薄导体内部多次反射后的总反射率如下.</p><p>$$
\begin{equation}
R&rsquo; = R + TRT + TRRRT + \cdots = R + \frac{T^2R}{1-R^2}
\end{equation}
$$</p><h3 class="relative group">非对称散射与折射<div id=%E9%9D%9E%E5%AF%B9%E7%A7%B0%E6%95%A3%E5%B0%84%E4%B8%8E%E6%8A%98%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E6%95%A3%E5%B0%84%E4%B8%8E%E6%8A%98%E5%B0%84 aria-label=锚点>#</a></span></h3><p>BRDF都是对称的, 即入射与反射方向可以交换, 但BTDF不是, 因为IOR的变化会导致折射后光线范围的变化, 为保持能量守恒光线的辐亮度不再保持一致. 根据能量守恒我们可以认为\(d^2\phi_o = d^2\phi_i\), 结合辐亮度的定义与Snell定律可以推导出如下的关系. 由于路径追踪实际上为光线传播的逆过程, 在折射时需要考虑非对称折射的现象.</p><p>$$
\begin{equation}
\eta_o^2 f_t(p, \omega_o, \omega_i) = \eta_i^2 f_t(p, \omega_i, \omega_o)
\end{equation}
$$</p><h2 class="relative group">微表面理论<div id=%E5%BE%AE%E8%A1%A8%E9%9D%A2%E7%90%86%E8%AE%BA class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%BE%AE%E8%A1%A8%E9%9D%A2%E7%90%86%E8%AE%BA aria-label=锚点>#</a></span></h2><p>大部分物体表面在微观上是粗糙的, 这可以通过微表面理论模拟, 这避免了对建模精度的要求, 且更适用于Monte Carlo.</p><h3 class="relative group">法线分布函数<div id=%E6%B3%95%E7%BA%BF%E5%88%86%E5%B8%83%E5%87%BD%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B3%95%E7%BA%BF%E5%88%86%E5%B8%83%E5%87%BD%E6%95%B0 aria-label=锚点>#</a></span></h3><p>微表面分布主要定义了法线的分布, 由于光源与观察者都与表面相距较远, 这种概率表示是可行的. 宏表面与微表面所占的面积关系如下, 即微表面沿宏观法线投影的面积与宏表面面积相等.</p><p>$$
\begin{equation}
\int_{dA_\mu}(\omega_m(p) \cdot \bold{n}) dp = \int_{dA} dp
\end{equation}
$$</p><p>将所有具有某个方向的法线的微表面在宏表面上的相对投影面积定义为法线分布函数, 此时可以得到法线分布函数的归一化性质.</p><p>$$
\begin{equation}
\int_\Omega D(\omega_m)(\omega_m \cdot \bold{n}) d\omega_m = \int_\Omega D(\omega_m) \cos\theta_m d\omega_m = 1
\end{equation}
$$</p><p>若转为斜率分布, 可以得到如下关系.</p><p>$$
\begin{equation}
\int_{-\infty}^{\infty} \int_{-\infty}^{\infty} P^{22}(x_{\tilde{m}},y_{\tilde{m}}) dx_{\tilde{m}} dy_{\tilde{m}}=1
\end{equation}
$$</p><p>根据平面的定义\(x_mx+y_my+z_mz+c=0\), 法线与斜率具有如下的关系.</p><p>$$
\begin{equation}
\begin{aligned}
(x_{\tilde{m}},y_{\tilde{m}})&=(-\frac{x_m}{z_m},-\frac{y_m}{z_m})=-\tan\theta_m(\cos\phi_m,\sin\phi_m)\\
(x_m, y_m, z_m)&=\frac{(-x_{\tilde{m}},-y_{\tilde{m}},1)}{\sqrt{x_{\tilde{m}}^2+y_{\tilde{m}}^2+1}}=(-x_{\tilde{m}},-y_{\tilde{m}},1)\cos\theta_m
\end{aligned}
\end{equation}
$$</p><p>Jacobi行列式的计算结果如下.</p><p>$$
\begin{equation}
dx_{\tilde{m}}dy_{\tilde{m}}=\frac{\sin\theta}{\cos^3\theta}d\theta d\phi
\end{equation}
$$</p><p>此时可以得到法线分布函数与斜率分布函数的转换关系.</p><p>$$
\begin{equation}
D(\omega_m) = \frac{P^{22}(x_{\tilde{m}},y_{\tilde{m}}) dx_{\tilde{m}} dy_{\tilde{m}}}{\cos\theta \sin\theta d\theta d\phi} = \frac{P^{22}(x_{\tilde{m}},y_{\tilde{m}})}{\cos^4\theta}
\end{equation}
$$</p><p>若法线分布函数为形状无关的, 即修改粗糙度等价于对法线分布函数进行拉伸, 则其斜率分布需要满足如下形式.</p><p>$$
\begin{equation}
\begin{aligned}
P^{22}(x_{\tilde{m}},y_{\tilde{m}})
&=\frac{1}{\alpha_x\alpha_y}f(\sqrt{\frac{x_{\tilde{m}^2}}{\alpha_x^2} + \frac{y_{\tilde{m}^2}}{\alpha_y^2}})\\
&=\frac{1}{\alpha_x\alpha_y}f(\tan\theta_m\sqrt{\frac{\cos^2\phi_m}{\alpha_x^2} + \frac{\sin^2\phi_m}{\alpha_y^2}})
\end{aligned}
\end{equation}
$$</p><p>对于渲染任务最常用的Trowbridge-Reitz法线分布函数定义如下.</p><p>$$
\begin{equation}
\begin{aligned}
P^{22}(x_{\tilde{m}},y_{\tilde{m}}) &= \frac{1}{\pi\alpha_x\alpha_y(1+\frac{x_{\tilde{m}^2}}{\alpha_x^2} + \frac{y_{\tilde{m}^2}}{\alpha_y^2})^2}\\
D(\omega_m) &= \frac{1}{\pi\alpha_x\alpha_y\cos^4\theta_m(1+\tan^2\theta_m(\frac{\cos^2\phi_m}{\alpha_x^2} + \frac{\sin^2\phi_m}{\alpha_y^2}))^2}
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">遮蔽函数<div id=%E9%81%AE%E8%94%BD%E5%87%BD%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%81%AE%E8%94%BD%E5%87%BD%E6%95%B0 aria-label=锚点>#</a></span></h3><p>微表面可能会被遮挡, 需要通过遮蔽函数来表示某个方向上被遮蔽的比率.</p><p>$$
\begin{equation}
\int_\Omega D(\omega_m)G_1(\omega,\omega_m)(\omega\cdot\omega_m)d\omega_m=\omega\cdot\bold{n}=\cos\theta
\end{equation}
$$</p><p>Smith遮蔽函数认为法线与高度是独立的, 即微表面类似于一个一个浮动的小片段, 此时可以将遮蔽函数分解为局部遮蔽与全部遮蔽, 局部遮蔽只需要法线可见, 即\(\omega\cdot\omega_m>0\), 此时遮蔽函数不再依赖于微表面法线. 不失一般性, 令表面为各向同性的, 法线为局部空间中的\((0,0,1)\), 视线沿\(x\)轴为\((\sin\theta, 0, \cos\theta)\), 已知由于对称性\(\int_{-\infty}^{\infty}x_{\tilde{m}}P^{2-}(x_{\tilde{m}})dx_{\tilde{m}}=0\),\(\int_{-\infty}^{\infty}P^{2-}(x_{\tilde{m}})dx_{\tilde{m}}=1\),此时可以得到如下结果.</p><p>$$
\begin{equation}
\begin{aligned}
G_1(\omega)
&=\frac{\cos\theta}{\int_\Omega D(\omega_m)\max(0,\omega\cdot\omega_m)d\omega_m}\\
&=\frac{\cos\theta}{\int_\Omega D(\omega_m)\cos\theta_m\frac{\max(0,\omega\cdot\omega_m)}{\cos\theta_m}d\omega_m}\\
&=\frac{\cos\theta}{\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}P^{22}(x_{\tilde{m}},y_{\tilde{m}}) \frac{\max(0, (-x_{\tilde{m}}\sin\theta + \cos\theta)\cos\theta_m)}{\cos\theta_m} dx_{\tilde{m}} dy_{\tilde{m}}}\\
&=\frac{\cos\theta}{\int_{-\infty}^{\infty}\int_{-\infty}^{\cot\theta}P^{22}(x_{\tilde{m}},y_{\tilde{m}}) (-x_{\tilde{m}}\sin\theta + \cos\theta) dx_{\tilde{m}} dy_{\tilde{m}}}\\
&=\frac{\cot\theta}{\int_{-\infty}^{\cot\theta}P^{2-}(x_{\tilde{m}}) (-x_{\tilde{m}} + \cot\theta) dx_{\tilde{m}}}\\
&=\frac{\cot\theta}{\int_{-\infty}^{\infty}P^{2-}(x_{\tilde{m}}) x_{\tilde{m}} dx_{\tilde{m}}-\cot\theta\int_{-\infty}^{\infty}P^{2-}(x_{\tilde{m}}) dx_{\tilde{m}}+\cot\theta+\int_{-\infty}^{\cot\theta}P^{2-}(x_{\tilde{m}}) (-x_{\tilde{m}} + \cot\theta) dx_{\tilde{m}}}\\
&=\frac{1}{1+\frac{1}{\cot\theta}\int_{\cot\theta}^{\infty}P^{2-}(x_{\tilde{m}}) (x_{\tilde{m}} - \cot\theta) dx_{\tilde{m}}}\\
&=\frac{1}{1+\Lambda(\omega)}
\end{aligned}
\end{equation}
$$</p><p>各向同性的Trowbridge-Reitz的\(\Lambda(\omega)\)具有解析形式, 各向异性的粗糙度可以通过\(\alpha=\sqrt{\alpha_x^2\cos^2\phi+\alpha_y^2\sin^2\phi}\)得到.</p><p>$$
\begin{equation}
\begin{aligned}
\Lambda(\omega)
&=\frac{1}{\cot\theta}\int_{-\infty}^{\infty}\int_{\cot\theta}^{\infty}\frac{1}{\pi\alpha^2(1+\frac{x_{\tilde{m}^2}}{\alpha^2} + \frac{y_{\tilde{m}^2}}{\alpha^2})^2} (x_{\tilde{m}} - \cot\theta)dx_{\tilde{m}}dy_{\tilde{m}}\\
&=\frac{1}{\cot\theta}\int_{-\infty}^{\infty}\int_{\frac{\cot\theta}{\alpha}}^{\infty}\frac{\alpha}{\pi(1+(\frac{x_{\tilde{m}}}{\alpha})^2 + (\frac{y_{\tilde{m}}}{\alpha})^2)^2} (\frac{x_{\tilde{m}}}{\alpha} - \frac{\cot\theta}{\alpha})d\frac{x_{\tilde{m}}}{\alpha}d\frac{y_{\tilde{m}}}{\alpha}\\
&=\frac{1}{\pi x_0}\int_{-\infty}^{\infty}\int_{x_0}^{\infty}\frac{1}{(1+x^2+y^2)^2}(x-x_0)dxdy\\
&=\frac{1}{\pi x_0}\int_{x_0}^{\infty}(x-x_0)(1+x^2)^{-\frac{3}{2}}dx\int_{-\infty}^{\infty}\frac{1}{(1+(\frac{y}{\sqrt{1+x^2}})^2)^2}d\frac{y}{\sqrt{1+x^2}}\\
&=\frac{1}{\pi x_0}\int_{x_0}^{\infty}(x-x_0)(1+x^2)^{-\frac{3}{2}}dx\int_{-\infty}^{\infty}\frac{1}{(1+y^2)^2}dy\\
&=\frac{1}{\pi x_0}\int_{x_0}^{\infty}(x-x_0)(1+x^2)^{-\frac{3}{2}}dx\int_{-\infty}^{\infty}\frac{1}{(1+\tan^2\theta)^2}d\tan\theta\\
&=\frac{1}{\pi x_0}\int_{x_0}^{\infty}(x-x_0)(1+x^2)^{-\frac{3}{2}}dx\int_{-\frac{\pi}{2}}^{\frac{\pi}{2}}\frac{\cos2\theta+1}{2}d\theta\\
&=\frac{1}{2x_0}\int_{x_0}^{\infty}(x-x_0)(1+x^2)^{-\frac{3}{2}}dx\\
&=\frac{1}{2 x_0}\int_{x_0}^{\infty}(x-x_0)(-\frac{1}{x})d(1+x^2)^{-\frac{1}{2}}\\
&=\frac{1}{2 x_0}\int_{(1+x_0^2)^{-\frac{1}{2}}}^{0}\frac{x_0}{\sqrt{\frac{1}{x^2}-1}}-1dx\\
&=\frac{1}{2}\int_{0}^{(1+x_0^2)^{-\frac{1}{2}}}\frac{1}{x_0}-\frac{x}{\sqrt{1-x^2}}dx\\
&=\frac{1}{2}(\frac{(1+x_0^2)^{-\frac{1}{2}}}{x_0}+\int_{0}^{(1+x_0^2)^{-\frac{1}{2}}}d\sqrt{1-x^2})\\
&=\frac{1}{2}(\frac{(1+x_0)^{-\frac{1}{2}}}{x_0}+x_0(1+x_0)^{-\frac{1}{2}}-1)\\
&=\frac{\sqrt{1+\frac{1}{x_0^2}}-1}{2}\\
&=\frac{\sqrt{1+\alpha^2 \tan^2\theta}-1}{2}
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">遮蔽阴影函数<div id=%E9%81%AE%E8%94%BD%E9%98%B4%E5%BD%B1%E5%87%BD%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%81%AE%E8%94%BD%E9%98%B4%E5%BD%B1%E5%87%BD%E6%95%B0 aria-label=锚点>#</a></span></h3><p>除遮挡视线外, 光源也可能被微表面遮挡. 若采用\(G(\omega_o, \omega_i)=G_1(\omega_o)G_1(\omega_i)\)来估计是不准确的, 例如\(\omega_o=\omega_i\)的情况下是不应该被遮挡的. 通过高度相关性可以推导出更优的遮蔽阴影函数.</p><p>不失一般性, 令视线沿x轴, \(S(x)\)为视线方向从\(x=0\)上某个点出发行进\(x\)后未被遮挡的概率, \(g(x)dx\)为光线在\([x,x+dx]\)内被遮挡的概率, 此时\(S(x + dx)\)可以按如下方式表示.</p><p>$$
\begin{equation}
S(x+dx)=S(x)(1-g(x)dx)
\end{equation}
$$</p><p>将该式视为一阶Taylor展开, 此时可以得到微分方程, \(S(x)\)可以求解.</p><p>$$
\begin{equation}
\begin{aligned}
\frac{dS(x)}{dx}&=-S(x)g(x)\\
S(x)&=S(0)e^{-\int_0^x g(x)dx}
\end{aligned}
\end{equation}
$$</p><p>令视线在\(x\)轴上的斜率为\(\mu_v\), 表面在x轴的斜率为\(\mu(x)\), 则\(S(0)\)定义如下, 用\(s(\mu_v-\mu(0))\)表示.</p><p>$$
\begin{equation}
\begin{aligned}
S(0)=s(\mu_v-\mu(0))=
\begin{cases}
1 &\mu_v\ge\mu(0)\\
0 &\mu_v&lt;\mu(0)
\end{cases}
\end{aligned}
\end{equation}
$$</p><p>令表面高度为\(h(x)\), 条件\(\alpha\)为\(h(x)&lt;h(0)+\mu_v x\), 条件\(\beta\)为\(h(x+dx)>h(0)+\mu_v\cdot(x+dx)\), \(P_3(h,\mu|x)\)为\(x\)处斜率与高度的联合分布, 若在\([x,x+dx]\)处被遮挡需要满足\(\mu(x)>\mu_v\), 同时在Smith遮蔽函数下高度与斜率是不相关的, 此时可以定义\(g(x)\). \(P(\alpha,\beta)\)中对微分高度变化的积分使用微分面积计算.</p><p>$$
\begin{equation}
\begin{aligned}
g(x)
&=\frac{1}{dx}P(\beta|\alpha)\\
&=\frac{1}{dx}\frac{P(\alpha,\beta)}{P(\alpha)}\\
&=\frac{1}{dx}\frac{\int_{\mu_v}^\infty\int_{h(0)+\mu_v(x+dx)-\mu dx}^{h(0)+\mu_vx}P_3(h,\mu|x)dh d\mu}{\int_{-\infty}^{\infty}\int_{-\infty}^{h(0)+\mu_vx}P_3(h,\mu|x)dhd\mu}\\
&=\frac{1}{dx}\frac{\int_{\mu_v}^\infty(\mu-\mu_v)dxP_3(h(0)+\mu_vx,\mu|x)d\mu}{\int_{-\infty}^{\infty}\int_{-\infty}^{h(0)+\mu_vx}P_3(h,\mu|x)dhd\mu}\\
&=\frac{\int_{\mu_v}^\infty(\mu-\mu_v)P_h(h(0)+\mu_vx)P^{2-}(\mu)d\mu}{\int_{-\infty}^{h(0)+\mu_vx}P_h(h)dh}\\
&=\Lambda(\mu_v)\frac{\mu_vP_h(h(0)+\mu_vx)}{f(h(0)+\mu_vx)}
\end{aligned}
\end{equation}
$$</p><p>在Smith遮蔽函数下\(s(\mu_v-\mu(0))\)恒成立, 省去该项后可以得到不会被遮蔽的概率\(S(h)\).</p><p>$$
\begin{equation}
\begin{aligned}
S(h, \omega)
&= e^{-\Lambda(\omega)\int_0^{\infty}\frac{\mu_vP_h(h+\mu_vx)}{f(h+\mu_vx)}dx}\\
&= e^{-\Lambda(\omega)\left[\ln f(h+\mu_v x)\right]_0^{\infty}}\\
&= e^{-\Lambda(\omega)(\ln 1 - \ln f(h))}\\
&= e^{\Lambda(\omega)\ln f(h)}\\
&= f(h)^{\Lambda(\omega)}
\end{aligned}
\end{equation}
$$</p><p>此时可以得到Smith遮蔽函数的全局项, 可以看到与上一节的证明结果是相同的.</p><p>$$
\begin{equation}
\begin{aligned}
G_1(\omega)
&= \int_{-\infty}^{\infty} f(h)^{\Lambda(\omega)} P_h(h) dh\\
&= \int_{-\infty}^{\infty} f(h)^{\Lambda(\omega)} df(h)\\
&= \left[\frac{f(h)^{1+\Lambda(\omega)}}{1+\Lambda(\omega)}\right]_{-\infty}^{\infty}\\
&= \frac{1}{1+\Lambda(\omega)}
\end{aligned}
\end{equation}
$$</p><p>此时可以推导出遮蔽阴影函数.</p><p>$$
\begin{equation}
\begin{aligned}
G(\omega_o,\omega_i)
&= \int_{-\infty}^{\infty}f(h)^{\Lambda(\omega_o)}P_h(h)dh + \int_{-\infty}^{\infty}f(h)^{\Lambda(\omega_i)}P_h(h)dh\\
&= \int_{-\infty}^{\infty}f(h)^{\Lambda(\omega_o)+\Lambda(\omega_i)}P_h(h)dh\\
&= \frac{1}{1+\Lambda(\omega_o)+\Lambda(\omega_i)}
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">采样可见法线分布<div id=%E9%87%87%E6%A0%B7%E5%8F%AF%E8%A7%81%E6%B3%95%E7%BA%BF%E5%88%86%E5%B8%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%87%87%E6%A0%B7%E5%8F%AF%E8%A7%81%E6%B3%95%E7%BA%BF%E5%88%86%E5%B8%83 aria-label=锚点>#</a></span></h3><p>根据法线分布函数与遮蔽阴影函数我们可以得到视线为\(\omega\)时法线的分布.</p><p>$$
\begin{equation}
D_\omega(\omega_m)=\frac{G_1(\omega)}{\cos\theta}D(\omega_m)\max(0,\omega\cdot\omega_m)
\end{equation}
$$</p><p>由于逆变换法没有解析形式, pbrt将Trowbridge-Reitz分布看作一个被缩放的半球, 投影到半球上为椭圆. 因此将法线变换到\(z\)轴, 对视线方向乘上由各向异性粗糙度定义的椭圆轴长, 执行逆椭圆变换, 在半球中采样更为简单.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Transform _w_ to hemispherical configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Vector3f</span> <span class=n>wh</span> <span class=o>=</span> <span class=n>Normalize</span><span class=p>(</span><span class=n>Vector3f</span><span class=p>(</span><span class=n>alpha_x</span> <span class=o>*</span> <span class=n>w</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>alpha_y</span> <span class=o>*</span> <span class=n>w</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>w</span><span class=p>.</span><span class=n>z</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>wh</span><span class=p>.</span><span class=n>z</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>wh</span> <span class=o>=</span> <span class=o>-</span><span class=n>wh</span><span class=p>;</span>
</span></span></code></pre></div><p>构造以视线为\(z\)轴的正交坐标系, <code>T2</code>轴保证采样到缩放半圆的法线在该轴为负.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Transform _w_ to hemispherical configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Vector3f</span> <span class=n>wh</span> <span class=o>=</span> <span class=n>Normalize</span><span class=p>(</span><span class=n>Vector3f</span><span class=p>(</span><span class=n>alpha_x</span> <span class=o>*</span> <span class=n>w</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>alpha_y</span> <span class=o>*</span> <span class=n>w</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>w</span><span class=p>.</span><span class=n>z</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>wh</span><span class=p>.</span><span class=n>z</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>wh</span> <span class=o>=</span> <span class=o>-</span><span class=n>wh</span><span class=p>;</span>
</span></span></code></pre></div><p>将半球投影到\(xy\)平面时, 只有一侧是完整半圆, 另一侧是缩放了\(\cos\theta=\bold{n}\cdot\omega\)即<code>wh.z</code>的半圆. 令\(h=\sqrt{1-x^2}\), 原本采样得到的\(x\)对应的\(y\)范围为\((-h, h)\), 缩放后为\((-h\cos\theta, h)\), 相当于\(y&rsquo;=\frac{h}{2}(1+\cos\theta)y+\frac{h}{2}(1-\cos\theta)\), pbrt这里的<code>Lerp</code>与之等价.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Generate uniformly distributed points on the unit disk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Point2f</span> <span class=n>p</span> <span class=o>=</span> <span class=n>SampleUniformDiskPolar</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Warp hemispherical projection for visible normal sampling
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Float</span> <span class=n>h</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>Sqr</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>x</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>Lerp</span><span class=p>((</span><span class=mi>1</span> <span class=o>+</span> <span class=n>wh</span><span class=p>.</span><span class=n>z</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>p</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span></code></pre></div><p>最后将采样得到的法线变换回原本的空间, 由于法线的变换为逆变换的转置, 这里仍然乘上粗糙度.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// Reproject to hemisphere and transform normal to ellipsoid configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Float</span> <span class=n>pz</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>sqrt</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=o>&lt;</span><span class=n>Float</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>LengthSquared</span><span class=p>(</span><span class=n>Vector2f</span><span class=p>(</span><span class=n>p</span><span class=p>))));</span>
</span></span><span class=line><span class=cl><span class=n>Vector3f</span> <span class=n>nh</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=n>x</span> <span class=o>*</span> <span class=n>T1</span> <span class=o>+</span> <span class=n>p</span><span class=p>.</span><span class=n>y</span> <span class=o>*</span> <span class=n>T2</span> <span class=o>+</span> <span class=n>pz</span> <span class=o>*</span> <span class=n>wh</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>CHECK_RARE</span><span class=p>(</span><span class=mf>1e-5</span><span class=n>f</span><span class=p>,</span> <span class=n>nh</span><span class=p>.</span><span class=n>z</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nf>Normalize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Vector3f</span><span class=p>(</span><span class=n>alpha_x</span> <span class=o>*</span> <span class=n>nh</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>alpha_y</span> <span class=o>*</span> <span class=n>nh</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=o>&lt;</span><span class=n>Float</span><span class=o>&gt;</span><span class=p>(</span><span class=mf>1e-6</span><span class=n>f</span><span class=p>,</span> <span class=n>nh</span><span class=p>.</span><span class=n>z</span><span class=p>)));</span>
</span></span></code></pre></div><p>实时渲染IBL的重要性抽样中, 法线与视线方向是一致的, 因此可以对下式进行球面坐标上的重要性抽样.</p><p>$$
\begin{equation}
\int_{-\pi}^{\pi}\int_0^{\frac{\pi}{2}}D(\theta,\phi)\cos\theta\sin\theta d\theta d\phi = 1
\end{equation}
$$</p><p>各向同性的Trowbridge-Reitz在\(\theta,\phi\)上的PDF如下.</p><p>$$
\begin{equation}
\begin{aligned}
p(\theta)
&=\int_{0}^{2\pi}D(\theta,\phi)\cos\theta\sin\theta d\phi\\
&=\int_{0}^{2\pi}\frac{1}{\pi\alpha^2\cos^4\theta(1+\frac{\tan^2\theta}{\alpha^2})^2}\cos\theta\sin\theta d\phi\\
&=\frac{2\alpha^2\cos\theta\sin\theta}{\cos^4\theta(\alpha^2+\tan^2\theta)^2}\\
&=\frac{2\alpha^2\cos\theta\sin\theta}{(\alpha^2\cos^2\theta+\sin^2\theta)^2}\\
&=\frac{2\alpha^2\cos\theta\sin\theta}{((\alpha^2-1)\cos^2\theta+1)^2}\\
p(\phi)&=\frac{p(\theta,\phi)}{p(\theta)}=\frac{1}{2\pi}
\end{aligned}
\end{equation}
$$</p><p>由于逆变换法的需要, 计算二者的CDF.</p><p>$$
\begin{equation}
\begin{aligned}
P(\theta)
&=\int_0^{\theta}p(\theta_0)d\theta_0\\
&=\int_0^{\theta}\frac{-2\alpha^2\cos\theta_0}{((\alpha^2-1)\cos^2\theta_0+1)^2}d\cos\theta_0\\
&=\int_1^{\cos\theta}\frac{-2\alpha^2x}{((\alpha^2-1)x^2+1)^2}dx\\
&=\int_1^{\cos\theta}\frac{\alpha^2}{(\alpha^2-1)}d\frac{1}{(\alpha^2-1)x^2+1}\\
&=\frac{\alpha^2}{(\alpha^2-1)}(\frac{1}{(\alpha^2-1)\cos^2\theta+1}-\frac{1}{\alpha^2})\\
&=\frac{1-\cos^2\theta}{((\alpha^2-1)\cos^2\theta+1)}\\
P(\phi)
&=\int_0^{\phi}p(\phi_0)d\phi_0=\frac{\phi}{2\pi}
\end{aligned}
\end{equation}
$$</p><p>通过逆变换法得到最终变换.</p><p>$$
\begin{equation}
\begin{aligned}
\theta
&=P^{-1}(u_0)
=\cos^{-1}\sqrt{\frac{1-u_0}{(\alpha^2-1)u_0+1}}\\
\phi
&=P^{-1}(u_1)
=2\pi u_1
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">Torrance-Sparrow模型<div id=torrance-sparrow%E6%A8%A1%E5%9E%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#torrance-sparrow%E6%A8%A1%E5%9E%8B aria-label=锚点>#</a></span></h3><p>综合以上结论我们可以推导出微表面上的Torrance-Sparrow BRDF并应用于材质中.</p><h4 class="relative group">半向量变换<div id=%E5%8D%8A%E5%90%91%E9%87%8F%E5%8F%98%E6%8D%A2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8D%8A%E5%90%91%E9%87%8F%E5%8F%98%E6%8D%A2 aria-label=锚点>#</a></span></h4><p>对于镜面反射表面法线\(\omega_m\)是位于\(\omega_o\)和\(\omega_o\)之间的, 因此也可以被称为半向量. 以\(\omega_o\)为中心即\(\theta_o=0\), 此时可以获取Jacobi行列式的变换结果.</p><p>$$
\begin{equation}
\begin{aligned}
\frac{d\omega_m}{d\omega_i}
&= \frac{\sin\theta_m d\theta_m d\phi_m}{\sin\theta_i d\theta_i d\phi_i}\\
&= \frac{\sin\theta_m d\theta_m d\phi_m}{\sin2\theta_m 2d\theta_m d\phi_m}\\
&= \frac{\sin\theta_m}{4\cos\theta_m\sin\theta_m}\\
&= \frac{1}{4(\omega_i\cdot\omega_m)}\\
&= \frac{1}{4(\omega_o\cdot\omega_m)}
\end{aligned}
\end{equation}
$$</p><h4 class="relative group">Torrance-Sparrow PDF<div id=torrance-sparrow-pdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#torrance-sparrow-pdf aria-label=锚点>#</a></span></h4><p>\(\omega_i\)的分布如下.</p><p>$$
\begin{equation}
p(\omega_i)=D_{\omega_o}(\omega_m)\frac{d\omega_m}{d\omega_i}=\frac{D_{\omega_o}(\omega_m)}{4(\omega_o\cdot\omega_m)}
\end{equation}
$$</p><h4 class="relative group">Torrance-Sparrow BRDF<div id=torrance-sparrow-brdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#torrance-sparrow-brdf aria-label=锚点>#</a></span></h4><p>在Monte Carlo下反射方程可以做如下近似.</p><p>$$
\begin{equation}
\begin{aligned}
L_o(p,\omega_o)
&=\int_\Omega f_r(p,\omega_o,\omega_i)L_i(p,\omega_i)\cos\theta_id\omega_i\\
&\approx \frac{f_r(p,\omega_o,\omega_i)L_i(p,\omega_i)\cos\theta_i}{p(\omega_i)}\\
&=F(\omega_o\cdot\omega_m)G(\omega_i,\omega_o)L_i(p,\omega_i)
\end{aligned}
\end{equation}
$$</p><p>由此可得Torrance-Sparrow BRDF.</p><p>$$
\begin{equation}
\begin{aligned}
f_r(p,\omega_o,\omega_i)
&=\frac{D_{\omega_o}(\omega_m)F(\omega_o,\omega_m)G(\omega_i)}{4(\omega_o\cdot\omega_m)\cos\theta_i}\\
&=\frac{D(\omega_m)F(\omega_o,\omega_m)G(\omega_i)G(\omega_o)}{4\cos\theta_i\cos\theta_o}\\
&\approx\frac{D(\omega_m)F(\omega_o,\omega_m)G(\omega_i, \omega_o)}{4\cos\theta_i\cos\theta_o}
\end{aligned}
\end{equation}
$$</p><h4 class="relative group">Torrance-Sparrow采样<div id=torrance-sparrow%E9%87%87%E6%A0%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#torrance-sparrow%E9%87%87%E6%A0%B7 aria-label=锚点>#</a></span></h4><p>若<code>Sample_wm</code>得到的\(\omega_i\)朝向表面下方, 这意味着反射后仍然位于微表面, 需要执行多次散射. pbrt不考虑这种情况, 显然在极为粗糙的表面这会导致能量损失.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Vector3f</span> <span class=n>wm</span> <span class=o>=</span> <span class=n>mfDistrib</span><span class=p>.</span><span class=n>Sample_wm</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Vector3f</span> <span class=n>wi</span> <span class=o>=</span> <span class=n>Reflect</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>wm</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>SameHemisphere</span><span class=p>(</span><span class=n>wo</span><span class=p>,</span> <span class=n>wi</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{};</span>
</span></span></code></pre></div><h2 class="relative group">粗糙绝缘体BSDF<div id=%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93bsdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93bsdf aria-label=锚点>#</a></span></h2><h3 class="relative group">粗糙绝缘体PDF<div id=%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93pdf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93pdf aria-label=锚点>#</a></span></h3><p>根据Snell定律我们可以把投影到与半向量垂直的平面上的部分抵消, 由此可得以下关系. 此时得到的半向量总是指向光学密度较大的一侧, 需要后续修正. 对于反射由于\(\eta_i=\eta_o\)这与半向量是等价的.</p><p>$$
\begin{equation}
\omega_m=\frac{\eta_i\omega_i+\eta_o\omega_o}{\Vert\eta_i\omega_i+\eta_o\omega_o\Vert}=\frac{\eta\omega_i+\omega_o}{\Vert\eta\omega_i+\omega_o\Vert}
\end{equation}
$$</p><p>此时Jacobi行列式结果如下, 这可以由几何关系推导得到, 具体见<a href=https://www.graphics.cornell.edu/~bjw/microfacetbsdf.pdf target=_blank>Water et al. 2007</a>.</p><p>$$
\begin{equation}
\begin{aligned}
\frac{d\omega_m}{d\omega_i}
&=\frac{|\omega_i\cdot\omega_m|\eta_i^2}{((\eta_i\omega_i+\eta_o\omega_o)\cdot\omega_m)^2}\\
&=\frac{|\omega_i\cdot\omega_m|}{((\omega_i\cdot\omega_m)+\frac{(\omega_o\cdot\omega_m)}{\eta})^2}
\end{aligned}
\end{equation}
$$</p><p><figure><img class="my-0 rounded-md" loading=lazy srcset="/render/1733816209202-pbrt-v4-episode-9/refract-jacobi_hu_ec0b01919c60e3e7.png 330w,
/render/1733816209202-pbrt-v4-episode-9/refract-jacobi_hu_6555acd58f830a72.png 660w,
/render/1733816209202-pbrt-v4-episode-9/refract-jacobi_hu_8f084cbe37681c61.png 1024w,
/render/1733816209202-pbrt-v4-episode-9/refract-jacobi_hu_36f4c55f0563a06.png 2x" src=/render/1733816209202-pbrt-v4-episode-9/refract-jacobi_hu_6555acd58f830a72.png alt="refract jacobi"></figure></p><h3 class="relative group">粗糙绝缘体BSDF<div id=%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93bsdf-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93bsdf-1 aria-label=锚点>#</a></span></h3><p>根据PDF可以将Torrance-Sparrow BRDF拓展到BTDF, 得到完整的BSDF.</p><p>$$
\begin{equation}
\begin{aligned}
f_t(p,\omega_o,\omega_i)
&=\frac{D_{\omega_o}(\omega_m)(1-F(\omega_o\cdot\omega_m))G(\omega_i)|\omega_i\cdot\omega_m|}{((\omega_i\cdot\omega_m)+\frac{(\omega_o\cdot\omega_m)}{\eta})^2|\cos\theta_i|}\\
&=\frac{D(\omega_m)(1-F(\omega_o\cdot\omega_m))G(\omega_i,\omega_o)}{((\omega_i\cdot\omega_m)+\frac{(\omega_o\cdot\omega_m)}{\eta})^2}\frac{|\omega_i\cdot\omega_m||\omega_o\cdot\omega_m|}{|\cos\theta_i||\cos\theta_o|}
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">粗糙绝缘体采样<div id=%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93%E9%87%87%E6%A0%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%B2%97%E7%B3%99%E7%BB%9D%E7%BC%98%E4%BD%93%E9%87%87%E6%A0%B7 aria-label=锚点>#</a></span></h3><p>与之前章节描述的一样, 对法线进行重要性抽样并随机选取反射或折射.</p><h2 class="relative group">BSDF测量值<div id=bsdf%E6%B5%8B%E9%87%8F%E5%80%BC class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bsdf%E6%B5%8B%E9%87%8F%E5%80%BC aria-label=锚点>#</a></span></h2><p>现实世界中的很多材质无法通过微表面模型表达, pbrt采用测量值来实现数据驱动的反射模型, 通过采样估计的粗糙度对应的法线分布来提高测量效率.</p><h3 class="relative group">测量过程<div id=%E6%B5%8B%E9%87%8F%E8%BF%87%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B5%8B%E9%87%8F%E8%BF%87%E7%A8%8B aria-label=锚点>#</a></span></h3><h4 class="relative group">参数化测量<div id=%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E9%87%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E9%87%8F aria-label=锚点>#</a></span></h4><p>由于测量出的BRDF在量级上可能差距较大, 不适合线性插值, pbrt将采样值变换为Monte Carlo权重的形式再插值.</p><p>$$
\begin{equation}
M^{(k)} = \frac{f_r(\omega_o, \omega_i^{(k)})\cos\theta_i^{(k)}}{p(\omega_i^{(k)})}
\end{equation}
$$</p><h4 class="relative group">BRDF求解<div id=brdf%E6%B1%82%E8%A7%A3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#brdf%E6%B1%82%E8%A7%A3 aria-label=锚点>#</a></span></h4><p>令\(M\)为样本插值, \(R(\omega_o, u)=\omega_i\)为重要性抽样, 数据驱动的BRDF可以按如下方式表示.</p><p>$$
\begin{equation}
f_r(\omega_o,\omega_i)=\frac{M(R^{-1}(\omega_o,\omega_i))p(\omega_i)}{\cos\theta_i}
\end{equation}
$$</p><h4 class="relative group">泛化微表面模型<div id=%E6%B3%9B%E5%8C%96%E5%BE%AE%E8%A1%A8%E9%9D%A2%E6%A8%A1%E5%9E%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B3%9B%E5%8C%96%E5%BE%AE%E8%A1%A8%E9%9D%A2%E6%A8%A1%E5%9E%8B aria-label=锚点>#</a></span></h4><p>对于测量值BRDF, 可以使用最基本的Smith遮蔽函数的定义来得到PDF, 因为可以通过数值积分计算这里不采用Smith遮蔽函数的解析形式.</p><p>$$
\begin{equation}
\begin{aligned}
p(\omega_i)
&= \frac{D_{\omega_o}(\omega_m)}{4(\omega_o\cdot\omega_m)}\\
&= \frac{D(\omega_m)\max(0,\omega_o\cdot\omega_m)}{4(\omega_o\cdot\omega_m)\int_\Omega D(\omega)\max(0,\omega_o,\omega)d\omega}\\
&= \frac{D(\omega_m)}{4\sigma(\omega_o)}
\end{aligned}
\end{equation}
$$</p><p>此时可以求解BRDF.</p><p>$$
\begin{equation}
f_r(\omega_o,\omega_i)=\frac{M(R^{-1}(\omega_o,\omega_i))D(\omega_m)}{4\sigma(\omega_o)\cos\theta_i}
\end{equation}
$$</p><h4 class="relative group">初始微表面模型<div id=%E5%88%9D%E5%A7%8B%E5%BE%AE%E8%A1%A8%E9%9D%A2%E6%A8%A1%E5%9E%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%88%9D%E5%A7%8B%E5%BE%AE%E8%A1%A8%E9%9D%A2%E6%A8%A1%E5%9E%8B aria-label=锚点>#</a></span></h4><p>法线分布函数只有两个维度, 不会有维度组合数量的问题, 因此可以通过估计\(D(\omega)\)来获取初始微表面模型. 对于右侧的积分, 可以先测量\(f_r(p, \omega_j, \omega_j)\)作为\(D(\omega_j)\)的估计, 即不考虑遮蔽函数.</p><p>$$
\begin{equation}
\begin{aligned}
f_r(p,\omega,\omega)&=\frac{D(\omega)F(\omega\cdot\omega)G(\omega,\omega)}{4\cos^2\theta}\propto\frac{D(\omega)G_1(\omega)}{\cos^2\theta}\\
D(\omega)&\propto f_r(p,\omega,\omega)\cos\theta\int_\Omega D(\omega_m)\max(0,\omega\cdot\omega_m)d\omega_m
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">基础数据结构<div id=%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84 aria-label=锚点>#</a></span></h3><p>通过<code>PiecewiseLinear2D</code>实现插值与采样.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=k>struct</span> <span class=nc>MeasuredBxDFData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MeasuredBxDFData Public Members
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>pstd</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>wavelengths</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PiecewiseLinear2D</span><span class=o>&lt;</span><span class=mi>3</span><span class=o>&gt;</span> <span class=n>spectra</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PiecewiseLinear2D</span><span class=o>&lt;</span><span class=mi>0</span><span class=o>&gt;</span> <span class=n>ndf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PiecewiseLinear2D</span><span class=o>&lt;</span><span class=mi>2</span><span class=o>&gt;</span> <span class=n>vndf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PiecewiseLinear2D</span><span class=o>&lt;</span><span class=mi>0</span><span class=o>&gt;</span> <span class=n>sigma</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>isotropic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PiecewiseLinear2D</span><span class=o>&lt;</span><span class=mi>2</span><span class=o>&gt;</span> <span class=n>luminance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>MeasuredBxDFData</span><span class=p>(</span><span class=n>Allocator</span> <span class=n>alloc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=n>ndf</span><span class=p>(</span><span class=n>alloc</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>sigma</span><span class=p>(</span><span class=n>alloc</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>vndf</span><span class=p>(</span><span class=n>alloc</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>luminance</span><span class=p>(</span><span class=n>alloc</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>spectra</span><span class=p>(</span><span class=n>alloc</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=n>wavelengths</span><span class=p>(</span><span class=n>alloc</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>MeasuredBxDFData</span> <span class=o>*</span><span class=nf>Create</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>&amp;</span><span class=n>filename</span><span class=p>,</span> <span class=n>Allocator</span> <span class=n>alloc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>ToString</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>StringPrintf</span><span class=p>(</span><span class=s>&#34;[ MeasuredBxDFData filename: %s ]&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 class="relative group">求解<div id=%E6%B1%82%E8%A7%A3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B1%82%E8%A7%A3 aria-label=锚点>#</a></span></h3><p><code>MeasuredBxDF</code>中存储<code>MeasuredBxDFData</code>指针并实现相应的功能.</p><h2 class="relative group">毛发散射<div id=%E6%AF%9B%E5%8F%91%E6%95%A3%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%AF%9B%E5%8F%91%E6%95%A3%E5%B0%84 aria-label=锚点>#</a></span></h2><p>各个波长在毛发上的反射率是类似的, 因此毛发的颜色主要由吸收的折射光的量决定. 这可以通过<code>DielectricBxDF</code>与体渲染结合实现, 但这种方式计算量较大且无法实现重要性抽样. 特化的毛发BSDF可以解决该问题.</p><h3 class="relative group">几何<div id=%E5%87%A0%E4%BD%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%87%A0%E4%BD%95 aria-label=锚点>#</a></span></h3><p>毛发通过<code>Curve</code>实现, pbrt假设毛发为朝向入射光的带状曲面, 毛发BSDF基于圆柱形曲面, 在毛发不相互交织且不比像素宽很多的情况下, 这种转换是可行的.</p><p>对于光线与圆柱曲面的交点\(u,v\), \(u\)上的法线都位于同一平面, 此时令\(\frac{\partial p}{\partial u}\)为\(x\)轴, \(\frac{\partial p}{\partial v}\)为\(y\)轴, 入射光线可以转为纵向角与方位角, 即与\(x\)的夹角为\(\theta\), \(yz\)平面中与\(y\)的夹角为\(\phi\), 由于圆柱曲面的性质光线是位于\(yz\)平面的.</p><p>$$
\begin{equation}
\begin{aligned}
\theta &= \frac{\pi}{2}-\cos^{-1}(\omega\cdot x)\\
\phi &= \pi-\text{sign}(\omega\cdot z)(\pi - \cos^{-1}(\omega\cdot y))
\end{aligned}
\end{equation}
$$</p><p>根据\(v\)的定义, 交点距离圆心的距离为\(-1+2v\), 此时可以得到光线与法线的夹角\(\gamma\).</p><p>$$
\begin{equation}
\gamma = \sin^{-1}(-1+2v)
\end{equation}
$$</p><h3 class="relative group">毛发散射<div id=%E6%AF%9B%E5%8F%91%E6%95%A3%E5%B0%84-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%AF%9B%E5%8F%91%E6%95%A3%E5%B0%84-1 aria-label=锚点>#</a></span></h3><p>毛发包含发鳞, 发皮质, 发髓三个部分, 发髓由一些列表面的凸起构成, 发皮质与发髓包含吸收光的色素, 以发髓的颜色为主. pbrt假设毛发表面是与圆柱夹角为\(\alpha\)的圆锥状凸起, 毛发内部为同一介质即不产生内部散射. 同时pbrt假设光线在毛发上的相同位置入射与出射, 此时可以使用BSDF.</p><p>光线会在毛发内部多次反射与折射, 令\(p\)为光线进入空气前反射或折射的次数, 例如\(p=0\)为第一次反射\(R\), \(p=1\)为第二次折射\(TT\), \(p=3\)为\(TRT\). 此时BSDF可以写为如下形式, 其中\(M_p\)为纵向散射方程, \(N_p\)为方位散射方程, \(A_p\)为衰减方程, 分母用于抵消Kajiya中的余弦项. pbrt只计算\(p\le 3\)的BSDF, 余项合并为一项.</p><p>$$
\begin{equation}
\begin{aligned}
f(\omega_o,\omega_i)
&=\sum_{p=0}^{\infty} f_p(\omega_o,\omega_i)\\
&=\sum_{p=0}^{\infty} \frac{M_p(\theta_o,\theta_i)A_p(\omega_o)N_p(\phi)}{\cos\theta_i}\\
\end{aligned}
\end{equation}
$$</p><p><code>HairBxDF</code>构造函数如下, 其中\(h\)为与曲线中心的偏移, \(\eta\)为相对IOR, \(\sigma_a\)为毛发内部的吸收率系数(吸收率与光线传播距离有关, 后续体渲染章节会介绍), \(\beta_m\)为纵向粗糙度, \(\beta_n\)为方位粗糙度, \(\alpha\)为毛发表面凸起的夹角.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span>
</span></span><span class=line><span class=cl><span class=nf>HairBxDF</span><span class=p>(</span><span class=n>Float</span> <span class=n>h</span><span class=p>,</span> <span class=n>Float</span> <span class=n>eta</span><span class=p>,</span> <span class=k>const</span> <span class=n>SampledSpectrum</span> <span class=o>&amp;</span><span class=n>sigma_a</span><span class=p>,</span> <span class=n>Float</span> <span class=n>beta_m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>Float</span> <span class=n>beta_n</span><span class=p>,</span> <span class=n>Float</span> <span class=n>alpha</span><span class=p>);</span>
</span></span></code></pre></div><h3 class="relative group">纵向散射<div id=%E7%BA%B5%E5%90%91%E6%95%A3%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BA%B5%E5%90%91%E6%95%A3%E5%B0%84 aria-label=锚点>#</a></span></h3><p>纵向散射方程如下, 其中\(I_0\)为第一类Bessel方程的修改, \(v\)为粗糙度.
$$
\begin{equation}
M_p(\theta_o,\theta_i)=\frac{e^{-\frac{\sin\theta_i\sin\theta_o}{v}}}{2v\text{sinh}(\frac{1}{v})}I_0(\frac{\cos\theta_o\cos\theta_i}{v})
\end{equation}
$$</p><p>pbrt根据\(\beta_m\)计算不同\(p\)下的粗糙度.</p><p>$$
\begin{equation}
\begin{aligned}
v_0 &= (0.726\beta_m+0.812\beta_m^2+3.7\beta_m^20)^2\\
v_1 &= 0.25v_0\\
v_2 &= v_3 = \cdots = v_{\max} = 4v_0
\end{aligned}
\end{equation}
$$</p><h3 class="relative group">纤维吸收<div id=%E7%BA%A4%E7%BB%B4%E5%90%B8%E6%94%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%BA%A4%E7%BB%B4%E5%90%B8%E6%94%B6 aria-label=锚点>#</a></span></h3><p>吸收率受光线传播距离影响, 这需要计算折射光线的纵向角与方位角. 纵向角可以通过Snell定律获取, 方位角可以通过将\(\omega_t\)投影到\(yz\)平面计算, 也可以使用修改后的IOR通过Snell定律计算.</p><p>$$
\begin{equation}
\eta&rsquo;=\frac{\sqrt{\eta^2-\sin^2\theta_o}}{\cos\theta_o}
\end{equation}
$$</p><p>根据直线与圆相交的性质可以得到在\(yz\)传播的距离, 除以纵向角的余弦即可获取传播距离.</p><p>$$
\begin{equation}
l=\frac{2\cos\gamma_t}{\cos\theta_t}
\end{equation}
$$</p><p>利用后面体渲染章节介绍的Beer定律可以得到经过吸收后的透射率.</p><p>$$
\begin{equation}
T_r=e^{-\sigma_a l}
\end{equation}
$$</p><p>此时可以得到\(A_p\)的定义, 余项可以通过通项公式得到.</p><p>$$
\begin{equation}
\begin{aligned}
A_p&=
\begin{cases}
A_{p-1}Tf=(1-f)^2 T^p f^{p-1} & p>0\\
f & p=0
\end{cases}
\end{aligned}
\end{equation}
$$</p><p>$$
\begin{equation}
\sum_{p=p_{\max}}^{\infty}(1-f)^2 T^p f^{p-1}=\frac{(1-f)^2 T^{p_{\max}} f^{p_{\max}-1}}{1-Tf}
\end{equation}
$$</p><h3 class="relative group">方位散射<div id=%E6%96%B9%E4%BD%8D%E6%95%A3%E5%B0%84 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%96%B9%E4%BD%8D%E6%95%A3%E5%B0%84 aria-label=锚点>#</a></span></h3><p>方位散射只需要考虑\(\phi\), 即只需要考虑投影到\(yz\)平面上的圆, 以顺时针为正, 此时可以得到每次出射时的角度变化.</p><p>$$
\begin{equation}
\phi(p,h)=2p\gamma_t-2\gamma_o+p\pi
\end{equation}
$$</p><p>对于粗糙度, pbrt选用截尾Logistic分布, 与Gaussian分布相比Logistic具有相似的形状且具有积分解析式.</p><p>$$
\begin{equation}
l_t(x,s,[a,b])=\frac{l(x,s)}{\int_a^b l(x&rsquo;,s)dx&rsquo;}
\end{equation}
$$</p><p>pbrt根据\(\beta_n\)计算\(s\).</p><p>$$
\begin{equation}
s=\sqrt{\frac{\pi}{8}}(0.265\beta_n+1.194\beta_n^2+5.372\beta_n^{22})
\end{equation}
$$</p><h3 class="relative group">散射模型求解<div id=%E6%95%A3%E5%B0%84%E6%A8%A1%E5%9E%8B%E6%B1%82%E8%A7%A3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%95%A3%E5%B0%84%E6%A8%A1%E5%9E%8B%E6%B1%82%E8%A7%A3 aria-label=锚点>#</a></span></h3><p>头发表面的凸起角度\(\alpha\)会影响\(\theta\), pbrt估计\(R\)偏移\(2\alpha\), \(TT\)偏移\(-\alpha\), \(TRT\)会偏移\(-4\alpha\). 角度的偏移会导致高光瓣的偏移, 在头发上呈现出来的就是不同颜色的分层高光, 因为反射不影响颜色而折射会吸收光线.</p><h4 class="relative group">可逆性<div id=%E5%8F%AF%E9%80%86%E6%80%A7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8F%AF%E9%80%86%E6%80%A7 aria-label=锚点>#</a></span></h4><p>毛发BSDF是不可逆的, 这是由凸起方向以及\(A_p\), \(N_p\)与折射方向相关导致的.</p><h3 class="relative group">采样<div id=%E9%87%87%E6%A0%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E9%87%87%E6%A0%B7 aria-label=锚点>#</a></span></h3><p>首先以\(A_p\)作为概率分布采样\(p\), 然后分别采样\(M_p\)与\(N_p\), 这两项都可以实现精确采样.</p><h3 class="relative group">毛发吸收系数<div id=%E6%AF%9B%E5%8F%91%E5%90%B8%E6%94%B6%E7%B3%BB%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%AF%9B%E5%8F%91%E5%90%B8%E6%94%B6%E7%B3%BB%E6%95%B0 aria-label=锚点>#</a></span></h3><p>毛发的颜色由发皮质中的色素对光的吸收能力决定, 但毛发吸收系数与毛发颜色并不直接相关. 人类毛发中黑色素的浓度决定由金色到黑色的变化, 黄黑色素决定由橙色到红色的变化, pbrt中可以通过指定二者的浓度获取期望的发色.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>PBRT_CPU_GPU</span> <span class=n>RGBUnboundedSpectrum</span> <span class=n>HairBxDF</span><span class=o>::</span><span class=n>SigmaAFromConcentration</span><span class=p>(</span><span class=n>Float</span> <span class=n>ce</span><span class=p>,</span> <span class=n>Float</span> <span class=n>cp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RGB</span> <span class=nf>eumelaninSigma_a</span><span class=p>(</span><span class=mf>0.419f</span><span class=p>,</span> <span class=mf>0.697f</span><span class=p>,</span> <span class=mf>1.37f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RGB</span> <span class=nf>pheomelaninSigma_a</span><span class=p>(</span><span class=mf>0.187f</span><span class=p>,</span> <span class=mf>0.4f</span><span class=p>,</span> <span class=mf>1.05f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RGB</span> <span class=n>sigma_a</span> <span class=o>=</span> <span class=n>ce</span> <span class=o>*</span> <span class=n>eumelaninSigma_a</span> <span class=o>+</span> <span class=n>cp</span> <span class=o>*</span> <span class=n>pheomelaninSigma_a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PBRT_IS_GPU_CODE
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>return</span> <span class=nf>RGBUnboundedSpectrum</span><span class=p>(</span><span class=o>*</span><span class=n>RGBColorSpace_sRGB</span><span class=p>,</span> <span class=n>sigma_a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>return</span> <span class=nf>RGBUnboundedSpectrum</span><span class=p>(</span><span class=o>*</span><span class=n>RGBColorSpace</span><span class=o>::</span><span class=n>sRGB</span><span class=p>,</span> <span class=n>sigma_a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span>
</span></span></code></pre></div></div></div><script>var oid="views_render/1733816209202-pbrt-v4-episode-9/index.md",oid_likes="likes_render/1733816209202-pbrt-v4-episode-9/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/render/1732940841429-pbrt-v4-episode-8/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">pbrt-v4 Ep. VIII: 图像重建</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-11-30T00:00:00+00:00>2024 November 30</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/render/1735024711799-pbrt-v4-episode-10/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">pbrt-v4 Ep. X: 材质纹理</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-12-24T00:00:00+00:00>2024 December 24</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=tsssni/tsssni.github.io data-repo-id=R_kgDOMEzJ_g data-category=Announcements data-category-id=DIC_kwDOMEzJ_s4CgBEJ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://tsssni.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>